<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Hub</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Fraunces:ital,opsz,wght@0,9..144,200;0,9..144,500&display=swap" rel="stylesheet">
<style>
/* â•â•â• GLOBAL â•â•â• */
:root{
  --bg:#0e0e10;--surface:#18181c;--surface2:#222228;--border:#2e2e38;
  --accent:#60aaff;--accent2:#a0cfff;--accent3:#60d4ff;--accent4:#f0a060;--accent5:#60c8f0;
  --text:#e8e8f0;--muted:#888898;--danger:#f06060;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* â•â•â• TOP NAV â•â•â• */
#main-nav{display:flex;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none}
#main-nav::-webkit-scrollbar{display:none}
.mnav{flex:1;min-width:80px;padding:13px 6px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}
.mnav.active{color:var(--accent);border-bottom-color:var(--accent)}

/* â•â•â• SCREENS â•â•â• */
.screen{display:none;flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.screen.active{display:flex;flex-direction:column}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-projects{}
.pj-subview{display:none;flex-direction:column;flex:1}
.pj-subview.active{display:flex}

.pg-header{padding:18px 16px 10px;display:flex;align-items:baseline;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0}
.pg-title{font-family:'Fraunces',serif;font-size:22px;font-weight:200;color:var(--accent)}
.pg-sub{color:var(--muted);font-size:11px}

#proj-list-body{padding:14px 16px;display:flex;flex-direction:column;gap:10px;flex:1}
.proj-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;position:relative;overflow:hidden;flex-shrink:0}
.proj-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--card-color,var(--accent));border-radius:12px 12px 0 0}
.proj-card:active{background:var(--surface2)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.card-name{font-family:'Fraunces',serif;font-size:17px;font-weight:200;line-height:1.2}
.spill{font-size:9px;padding:3px 7px;border-radius:20px;white-space:nowrap;flex-shrink:0;font-weight:500;letter-spacing:.04em;text-transform:uppercase}
.sp-ns{background:#2e2e38;color:var(--muted)}
.sp-ip{background:#0e2040;color:var(--accent)}
.sp-dn{background:#0e2535;color:var(--accent2)}
.sp-oh{background:#2e1e1e;color:var(--accent4)}
.card-meta{margin-top:8px;display:flex;gap:12px;color:var(--muted);font-size:10px}

#add-proj-btn{margin:0 16px 20px;background:transparent;border:1px dashed var(--border);border-radius:12px;padding:13px;color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;text-align:center;flex-shrink:0}
#add-proj-btn:active{border-color:var(--accent);color:var(--accent)}

#proj-detail-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
#pj-back{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:5px 10px;cursor:pointer;flex-shrink:0}
#pj-name-hdr{font-family:'Fraunces',serif;font-size:18px;font-weight:200;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#pj-del{background:transparent;border:none;color:var(--danger);font-size:17px;cursor:pointer;padding:4px 6px;flex-shrink:0}

.sec{padding:16px 16px 0;flex-shrink:0}
.sec-title{font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sec-title::after{content:'';flex:1;height:1px;background:var(--border)}

#pj-status-row{display:flex;gap:7px;flex-wrap:wrap}
.st-btn{padding:5px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;text-transform:uppercase;letter-spacing:.04em}
.st-btn.a-ns{background:#2e2e38;color:var(--text);border-color:#555}
.st-btn.a-ip{background:#0e2040;color:var(--accent);border-color:var(--accent)}
.st-btn.a-dn{background:#0e2535;color:var(--accent2);border-color:var(--accent2)}
.st-btn.a-oh{background:#2e1e1e;color:var(--accent4);border-color:var(--accent4)}

#pj-notes{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;line-height:1.6;width:100%;min-height:90px;resize:none;outline:none}
#pj-notes:focus{border-color:var(--accent)}
#pj-notes::placeholder{color:var(--muted)}

#pj-tasks-list,#pj-links-list{display:flex;flex-direction:column;gap:5px;margin-bottom:8px}
.t-item,.l-item{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 10px}
.t-chk{width:17px;height:17px;border-radius:50%;border:1.5px solid var(--border);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px}
.t-chk.chk{background:var(--accent);border-color:var(--accent);color:#0e0e10}
.t-inp{flex:1;font-size:12px;color:var(--text);background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;width:100%}
.t-inp.done{text-decoration:line-through;color:var(--muted)}
.xbtn{background:transparent;border:none;color:var(--border);font-size:15px;cursor:pointer;padding:0 3px;flex-shrink:0}
.xbtn:active{color:var(--danger)}
.add-line{background:transparent;border:1px dashed var(--border);border-radius:8px;padding:7px 10px;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;width:100%;text-align:left}
.add-line:active{border-color:var(--accent);color:var(--accent)}
.l-ins{flex:1;display:flex;flex-direction:column;gap:3px}
.l-inp{background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;color:var(--text);font-size:11px;width:100%}
.l-inp.url{color:var(--accent2);font-size:10px}
.l-inp::placeholder{color:var(--muted)}

#proj-empty{text-align:center;padding:50px 16px;color:var(--muted)}
#proj-empty .big{font-size:36px;margin-bottom:10px}
#proj-empty p{font-size:12px;line-height:1.6}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GROCERY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-grocery{}
.tab-row{display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;overflow-x:auto;scrollbar-width:none}
.tab-row::-webkit-scrollbar{display:none}
.gtab{flex:1;min-width:72px;padding:11px 6px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}
.gtab.active{color:var(--accent);border-bottom-color:var(--accent)}.gview{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:14px 16px}
.gview.active{display:block}

.loc-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.loc-btn{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;text-transform:uppercase;letter-spacing:.04em}
.loc-btn.active{background:var(--surface2);color:var(--accent);border-color:var(--accent)}
.gcard{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.item-row{display:flex;align-items:center;gap:7px;padding:7px 0;border-bottom:1px solid var(--border)}
.item-row:last-of-type{border-bottom:none}
.iname{flex:1;font-size:12px}
.iqty{width:52px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:3px 6px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;text-align:center;outline:none}
.iunit{width:54px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:3px 6px;color:var(--text);font-family:'DM Mono',monospace;font-size:10px;outline:none}
.ilow{color:var(--danger);font-size:9px;flex-shrink:0}

.add-row{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap}
.gi{flex:1;min-width:100px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none}
.gi:focus{border-color:var(--accent)}
.gi::placeholder{color:var(--muted)}
.gbtn{background:var(--accent);color:#0e0e10;border:none;border-radius:7px;padding:8px 13px;font-family:'DM Mono',monospace;font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap}
.gbtn-sm{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 9px;color:var(--text);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer}

/* calendar */
.cal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-ttl{font-family:'Fraunces',serif;font-size:18px;font-weight:200}
.cal-nav-btn{background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:5px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;cursor:pointer}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:12px}
.cdname{text-align:center;font-size:9px;color:var(--muted);padding:4px 0;text-transform:uppercase}
.cday{min-height:52px;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:3px;cursor:pointer}
.cday.om{opacity:.3}
.cday.tod{border-color:var(--accent2)}
.cday-n{font-size:9px;color:var(--muted);margin-bottom:1px}
.cmeal{font-size:8px;background:var(--surface2);border-radius:2px;padding:1px 3px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--accent);line-height:1.4}
.cmeal.lunch{color:var(--accent2)}.cmeal.dinner{color:var(--accent4)}

.twrow{display:flex;align-items:stretch;border-bottom:1px solid var(--border);padding:7px 0;gap:8px}
.twdate{width:68px;flex-shrink:0}
.twdate .dn{font-size:10px;color:var(--muted);text-transform:uppercase}
.twdate .dd{font-family:'Fraunces',serif;font-size:20px;font-weight:200;line-height:1}
.twmeals{flex:1;display:flex;flex-direction:column;gap:3px}
.mslot{display:flex;align-items:center;gap:5px}
.mlabel{font-size:9px;color:var(--muted);width:44px;flex-shrink:0;text-transform:uppercase}
.mval{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:4px 7px;font-size:11px;color:var(--text);font-family:'DM Mono',monospace;outline:none}
.mval:focus{border-color:var(--accent)}
.mval::placeholder{color:var(--muted)}
.rpick-btn{font-size:10px;background:transparent;border:none;color:var(--accent2);cursor:pointer;font-family:'DM Mono',monospace}

/* shopping */
.shop-item{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.schk{width:16px;height:16px;border-radius:4px;border:1.5px solid var(--border);background:transparent;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px}
.schk.chk{background:var(--accent);border-color:var(--accent);color:#0e0e10}
.sname{flex:1;font-size:12px}
.sname.done{text-decoration:line-through;color:var(--muted)}
.sdet{font-size:10px;color:var(--muted)}

/* recipes */
.rec-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden}
.rec-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px;cursor:pointer}
.rec-name{font-family:'Fraunces',serif;font-size:16px;font-weight:200}
.rec-body{display:none;padding:0 12px 12px;border-top:1px solid var(--border)}
.rec-body.open{display:block}
.rec-ta{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;line-height:1.5;resize:none;outline:none;min-height:70px;margin-top:8px}
.rec-ta:focus{border-color:var(--accent)}
.rtag{font-size:9px;padding:2px 6px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);color:var(--muted)}

/* modal */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:flex-end}
.modal-ov.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px 18px 0 0;padding:20px 16px 40px;width:100%;animation:slideUp .22s ease;max-height:80vh;overflow-y:auto}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h2{font-family:'Fraunces',serif;font-weight:200;font-size:20px;margin-bottom:14px;color:var(--accent)}
.mi{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;width:100%;outline:none;margin-bottom:10px}
.mi:focus{border-color:var(--accent)}
.mi::placeholder{color:var(--muted)}
.mact{display:flex;gap:8px;margin-top:6px}
.mprim{flex:1;background:var(--accent);color:#0e0e10;border:none;border-radius:8px;padding:11px;font-family:'DM Mono',monospace;font-size:12px;font-weight:500;cursor:pointer}
.msec{flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:11px;font-family:'DM Mono',monospace;font-size:12px;cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOWER GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-tower{padding:0;overflow:hidden}
#tower-wrap{display:flex;flex-direction:column;height:100%}
#g-topbar{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.gpill{display:flex;align-items:center;gap:4px;padding:3px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;font-size:10px}
.gpill span:first-child{color:var(--muted)}
#g-wave-info{font-family:'Fraunces',serif;font-size:14px;font-weight:500;color:var(--accent);margin-left:auto}
#g-set-btn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer}

#canvas-wrap{flex:1;position:relative;overflow:hidden;min-height:0}
canvas{display:block;width:100%;height:100%}

#g-bottom{background:var(--surface);border-top:1px solid var(--border);padding:8px 10px;flex-shrink:0}
#tower-btns{display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;margin-bottom:7px;scrollbar-width:none}
#tower-btns::-webkit-scrollbar{display:none}
.tbtn{flex-shrink:0;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;padding:6px 10px;cursor:pointer;text-align:center;min-width:62px}
.tbtn.sel{border-color:var(--accent);background:#0e2018}
.tbtn .ti{font-size:18px;display:block;margin-bottom:2px}
.tbtn .tn{font-size:9px;color:var(--muted);display:block}
.tbtn .tc{font-size:9px;color:var(--accent4);display:block}
#g-actrow{display:flex;gap:7px;align-items:center}
.gbtn2{background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:7px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;white-space:nowrap}
.gbtn2.prim{background:var(--accent);color:#0a0c0f;border-color:var(--accent);font-weight:500}
#g-sell{color:var(--danger)}
#g-info{font-size:10px;color:var(--muted);flex:1;text-align:right;line-height:1.4}

.g-overlay{display:none;position:absolute;inset:0;background:rgba(0,0,0,.85);z-index:50;align-items:center;justify-content:center;flex-direction:column;gap:14px;text-align:center;padding:20px}
.g-overlay.active{display:flex}
.g-overlay h1{font-family:'Fraunces',serif;font-size:32px;font-weight:500}
.g-overlay p{color:var(--muted);font-size:12px;max-width:260px;line-height:1.6}
.g-overlay .gbtn2{background:var(--accent);color:#0a0c0f;border-color:var(--accent);font-weight:500;padding:10px 24px;font-size:13px}

#g-settings{display:none;position:absolute;top:46px;right:10px;z-index:80;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:14px;width:220px}
#g-settings.open{display:block}
.srow{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.srow label{flex:1;font-size:10px;color:var(--muted)}
.srow input[type=range]{flex:1;accent-color:var(--accent)}
.srow .sv{width:30px;text-align:right;font-size:10px;color:var(--accent)}

#upg-panel{display:none;position:absolute;bottom:150px;left:10px;z-index:80;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:12px;width:200px}
#upg-panel.open{display:block}
#upg-panel h3{font-family:'Fraunces',serif;font-weight:500;font-size:15px;margin-bottom:8px;color:var(--accent2)}
.upg-btn{display:block;width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:7px 9px;color:var(--text);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;margin-bottom:5px;text-align:left}
.upg-btn:disabled{opacity:.4;cursor:default}
.upg-cost{color:var(--accent4);float:right}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORDLE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-wordle{overflow:hidden;display:none;flex-direction:column;height:100%}
#s-wordle.active{display:flex}

/* Header: single compact row with title, len tabs, stats btn */
#w-header{padding:8px 12px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:8px}
#w-title{font-family:'Fraunces',serif;font-size:18px;font-weight:200;color:var(--accent);flex-shrink:0}
#w-len-tabs{display:flex;gap:4px;flex:1}
.wlen-btn{padding:5px 0;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;flex:1;text-align:center;-webkit-tap-highlight-color:transparent}
.wlen-btn.active{background:#0e2040;color:var(--accent);border-color:var(--accent)}
#w-stats-btn{background:transparent;border:1px solid var(--border);border-radius:8px;padding:5px 10px;color:var(--muted);font-size:15px;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent}

/* Toast message */
#w-msg{height:18px;font-size:11px;color:var(--accent);text-align:center;font-weight:500;flex-shrink:0;padding-top:4px}

/* Game: fills remaining space, column layout */
#w-game{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;padding:0}

/* Board area: grows to fill space between msg and keyboard */
#w-board-area{flex:1;min-height:0;display:flex;align-items:stretch;justify-content:center;padding:4px 6px 4px}
#w-board{display:flex;flex-direction:column;width:100%;gap:4px}
.w-row{display:flex;flex:1;align-items:stretch;gap:4px;min-height:0}
.w-row-num{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);flex-shrink:0;width:14px;display:flex;align-items:center;justify-content:flex-end;padding-right:4px}
.w-row-num.active-num{color:var(--accent)}
.w-tiles{display:flex;flex:1;gap:4px;min-width:0}

/* Tiles: equal-width, slightly shorter than square */
.w-tile{
  flex:1;
  min-width:0;
  aspect-ratio:1/0.78;
  border:2px solid #3a3a45;border-radius:3px;
  display:flex;align-items:center;justify-content:center;
  font-family:'DM Mono',monospace;font-weight:700;font-size:clamp(13px,4.5vw,20px);
  text-transform:uppercase;color:var(--text);background:#111116;
  user-select:none;
}
.w-tile.filled{border-color:#565665}
.w-tile.correct{background:#538d4e;border-color:#6aaf60;color:#fff}
.w-tile.present{background:#b59400;border-color:#d4ae00;color:#fff}
.w-tile.absent{background:#3a3a45;border-color:#3a3a45;color:#e8e8f0}
.w-tile.shake{animation:wShake .4s ease}
@keyframes wShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-3px)}80%{transform:translateX(3px)}}
.w-tile.bounce{animation:wBounce .45s ease}
@keyframes wBounce{0%{transform:translateY(0)}30%{transform:translateY(-8px)}60%{transform:translateY(2px)}80%{transform:translateY(-2px)}100%{transform:translateY(0)}}
.w-tile.pop{animation:wPop .08s ease}
@keyframes wPop{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}

/* Keyboard: fixed height at bottom */
#w-keyboard{flex-shrink:0;display:flex;flex-direction:column;gap:7px;padding:4px 6px 10px}
.w-kbd-row{display:flex;gap:5px}
.w-key{
  flex:1;height:54px;border-radius:6px;border:none;
  background:#818384;color:#fff;
  font-family:'DM Mono',monospace;font-size:14px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;text-transform:uppercase;
  -webkit-tap-highlight-color:transparent;min-width:0;
}
.w-key.wide-enter{flex:1.7;font-size:11px}
.w-key.wide-del{flex:1.7;font-size:17px}
.w-key:active{filter:brightness(.8)}
.w-key.correct{background:#538d4e;color:#fff}
.w-key.present{background:#b59400;color:#fff}
.w-key.absent{background:#3a3a45;color:#818384}

#w-new-btn{display:none;margin:4px auto;background:var(--accent);color:#0e0e10;border:none;border-radius:8px;padding:8px 22px;font-family:'DM Mono',monospace;font-size:13px;font-weight:700;cursor:pointer}

/* Stats modal */
#w-stats-modal .modal{max-height:70vh;overflow-y:auto}
.w-dist-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:11px}
.w-dist-row .dlabel{width:14px;text-align:right;color:var(--muted);flex-shrink:0}
.w-dist-bar-wrap{flex:1;background:var(--surface2);border-radius:4px;overflow:hidden}
.w-dist-bar{height:18px;background:var(--accent);border-radius:4px;display:flex;align-items:center;padding:0 6px;font-size:10px;color:#0e0e10;font-weight:700;min-width:24px;transition:width .4s ease}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRM SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-crm{overflow:hidden;display:none;flex-direction:column}
#s-crm.active{display:flex}

/* Sub-tab bar */
#crm-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0}
.crm-tab{flex:1;padding:10px 4px;text-align:center;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
.crm-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* Views */
.crm-view{display:none;flex-direction:column;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.crm-view.active{display:flex}

/* Search bar */
#crm-search-wrap{padding:10px 14px 6px;flex-shrink:0}
#crm-search{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none}
#crm-search:focus{border-color:var(--accent)}
#crm-search::placeholder{color:var(--muted)}

/* Filter chips */
#crm-filters{display:flex;gap:6px;padding:0 14px 8px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
#crm-filters::-webkit-scrollbar{display:none}
.crm-chip{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:10px;cursor:pointer;white-space:nowrap}
.crm-chip.active{background:#0e2040;color:var(--accent);border-color:var(--accent)}

/* Contact cards */
#crm-list{padding:0 14px 80px;display:flex;flex-direction:column;gap:8px}
.crm-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:12px;flex-shrink:0}
.crm-card:active{background:var(--surface2)}
.crm-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-size:16px;font-weight:500;flex-shrink:0;color:#fff}
.crm-card-info{flex:1;min-width:0}
.crm-card-name{font-family:'Fraunces',serif;font-size:15px;font-weight:200;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.crm-card-sub{font-size:10px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.crm-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.crm-badge{font-size:9px;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.04em;font-weight:500}
.crm-badge-friend{background:#0e2040;color:var(--accent)}
.crm-badge-pro{background:#1a2010;color:#90d060}
.crm-badge-client{background:#2a1810;color:var(--accent4)}
.crm-follow-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);margin-top:2px}
.crm-follow-dot.soon{background:var(--accent4)}
.crm-follow-dot.ok{background:#538d4e}

#crm-add-btn{position:fixed;bottom:70px;right:18px;width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;color:#0e0e10;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(96,170,255,.35);z-index:10}

/* Follow-up queue */
#crm-queue-list{padding:10px 14px 80px;display:flex;flex-direction:column;gap:8px}
.crm-queue-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;flex-shrink:0}
.crm-queue-card:active{background:var(--surface2)}
.crm-queue-top{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.crm-queue-name{font-family:'Fraunces',serif;font-size:15px;font-weight:200;flex:1}
.crm-due-tag{font-size:9px;padding:3px 8px;border-radius:10px;font-weight:500;letter-spacing:.04em}
.crm-due-over{background:#2e1010;color:var(--danger)}
.crm-due-today{background:#2e1e10;color:var(--accent4)}
.crm-due-soon{background:#1e2e10;color:#90d060}
.crm-queue-action{font-size:11px;color:var(--muted);padding:6px 10px;background:var(--surface2);border-radius:8px}
.crm-queue-done{background:transparent;border:1px solid var(--border);border-radius:8px;padding:5px 12px;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;margin-top:8px;width:100%;text-align:center}
.crm-queue-done:active{border-color:var(--accent);color:var(--accent)}

/* Timeline */
#crm-timeline-list{padding:10px 14px 80px}
.crm-tl-day{font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin:12px 0 6px;display:flex;align-items:center;gap:8px}
.crm-tl-day::after{content:'';flex:1;height:1px;background:var(--border)}
.crm-tl-item{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start}
.crm-tl-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);margin-top:5px;flex-shrink:0}
.crm-tl-body{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer}
.crm-tl-who{font-size:11px;font-weight:500;color:var(--text);margin-bottom:2px}
.crm-tl-note{font-size:11px;color:var(--muted);line-height:1.5}

/* Detail view */
#crm-detail{display:none;flex-direction:column;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
#crm-detail.active{display:flex}
#crm-detail-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
#crm-back{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:5px 10px;cursor:pointer;flex-shrink:0}
#crm-detail-name{font-family:'Fraunces',serif;font-size:18px;font-weight:200;flex:1}
#crm-detail-del{background:transparent;border:none;color:var(--danger);font-size:17px;cursor:pointer;padding:4px}

#crm-detail-body{padding:14px;display:flex;flex-direction:column;gap:14px;padding-bottom:40px}
.crm-detail-avatar{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-size:26px;font-weight:500;color:#fff;margin:0 auto 2px}
.crm-detail-fullname{font-family:'Fraunces',serif;font-size:22px;font-weight:200;text-align:center}
.crm-detail-type{text-align:center;margin-top:4px}

.crm-field-group{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.crm-field{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);gap:10px}
.crm-field:last-child{border-bottom:none}
.crm-field-label{font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);width:64px;flex-shrink:0}
.crm-field-val{flex:1;font-size:12px;color:var(--text);background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;min-width:0}
.crm-field-val::placeholder{color:var(--muted)}

.crm-sec-title{font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.crm-sec-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* Log entry */
.crm-log-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:6px;position:relative}
.crm-log-date{font-size:9px;color:var(--muted);margin-bottom:3px}
.crm-log-text{font-size:12px;color:var(--text);line-height:1.5}
.crm-log-del{position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--border);font-size:14px;cursor:pointer;padding:2px 5px}
.crm-log-del:active{color:var(--danger)}

/* Tags */
.crm-tags-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.crm-tag{padding:3px 9px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:10px;color:var(--muted);display:flex;align-items:center;gap:4px}
.crm-tag-x{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:0 2px;line-height:1}
.crm-tag-x:active{color:var(--danger)}
.crm-tag-input{background:transparent;border:1px dashed var(--border);border-radius:20px;padding:3px 9px;font-size:10px;color:var(--text);font-family:'DM Mono',monospace;outline:none;width:80px}
.crm-tag-input::placeholder{color:var(--muted)}

/* Modals */
#crm-log-modal .modal textarea,#crm-contact-modal .modal textarea{min-height:80px;resize:none}
</style>
</head>
<body>

<!-- MAIN NAV -->
<div id="main-nav">
  <div class="mnav active" onclick="showScreen('projects')">âœ¦ Projects</div>
  <div class="mnav" onclick="showScreen('grocery')">ğŸ›’ Pantry</div>
  <div class="mnav" onclick="showScreen('tower')">âš”ï¸ Fortress</div>
  <div class="mnav" onclick="showScreen('wordle')">ğŸŸ© Wordle</div>
  <div class="mnav" onclick="showScreen('crm')">ğŸ‘¥ CRM</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PROJECTS â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="s-projects">
  <!-- List subview -->
  <div class="pj-subview active" id="pj-list">
    <div class="pg-header">
      <div class="pg-title">projects</div>
      <span class="pg-sub" id="pj-count">0 active</span>
    </div>
    <div id="proj-list-body">
      <div id="proj-empty"><div class="big">âœ¦</div><p>No projects yet.<br>Tap below to start one.</p></div>
    </div>
    <button id="add-proj-btn" onclick="openProjModal()">+ new project</button>
  </div>
  <!-- Detail subview -->
  <div class="pj-subview" id="pj-detail" style="padding-bottom:30px">
    <div id="proj-detail-header">
      <button id="pj-back" onclick="showProjList()">â† back</button>
      <div id="pj-name-hdr"></div>
      <button id="pj-del" onclick="delProj()">ğŸ—‘</button>
    </div>
    <div class="sec">
      <div class="sec-title">Status</div>
      <div id="pj-status-row">
        <button class="st-btn" data-s="ns">Not Started</button>
        <button class="st-btn" data-s="ip">In Progress</button>
        <button class="st-btn" data-s="dn">Done</button>
        <button class="st-btn" data-s="oh">On Hold</button>
      </div>
    </div>
    <div class="sec" style="margin-top:16px">
      <div class="sec-title">Ideas & Notes</div>
      <textarea id="pj-notes" placeholder="Jot down ideas, thoughts..."></textarea>
    </div>
    <div class="sec" style="margin-top:16px">
      <div class="sec-title">Tasks</div>
      <div id="pj-tasks-list"></div>
      <button class="add-line" id="pj-add-task">+ add task</button>
    </div>
    <div class="sec" style="margin-top:16px">
      <div class="sec-title">Links</div>
      <div id="pj-links-list"></div>
      <button class="add-line" id="pj-add-link">+ add link</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• GROCERY â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-grocery">
  <div class="tab-row">
    <div class="gtab active" onclick="gTab('inv')">ğŸ—„ Pantry</div>
    <div class="gtab" onclick="gTab('cal')">ğŸ“… Calendar</div>
    <div class="gtab" onclick="gTab('shop')">ğŸ›’ Shopping</div>
    <div class="gtab" onclick="gTab('rec')">ğŸ“– Recipes</div>
  </div>

  <!-- INVENTORY -->
  <div class="gview active" id="gv-inv">
    <div class="loc-row" id="g-loc-tabs"></div>
    <div class="gcard">
      <div id="g-items-list"></div>
      <div class="add-row">
        <input class="gi" id="g-iname" placeholder="Item..." />
        <input class="gi" id="g-iqty" placeholder="Qty" style="width:52px;flex:none" type="number" min="0" />
        <input class="gi" id="g-iunit" placeholder="unit" style="width:56px;flex:none" />
        <button class="gbtn" onclick="gAddItem()">Add</button>
      </div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div class="gview" id="gv-cal">
    <div class="cal-hdr">
      <button class="cal-nav-btn" onclick="gNavCal(-1)">â€¹</button>
      <div class="cal-ttl" id="g-cal-title"></div>
      <button class="cal-nav-btn" onclick="gNavCal(1)">â€º</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <button class="gbtn-sm" onclick="gSetCalView('month')" id="g-btn-month">Month</button>
      <button class="gbtn-sm" onclick="gSetCalView('twoweek')" id="g-btn-2wk">2-Week</button>
    </div>
    <div id="g-cal-container"></div>
  </div>

  <!-- SHOPPING -->
  <div class="gview" id="gv-shop">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">Shopping List</span>
      <button class="gbtn-sm" onclick="gGenShop()">Auto-generate</button>
    </div>
    <div class="gcard" style="margin-bottom:10px">
      <div class="add-row">
        <input class="gi" id="g-sname" placeholder="Item..." />
        <select class="gi" id="g-sstore" style="width:90px;flex:none;appearance:none">
          <option value="General">General</option>
          <option value="Grocery">Grocery</option>
          <option value="Costco">Costco</option>
          <option value="Walmart">Walmart</option>
          <option value="Target">Target</option>
        </select>
        <button class="gbtn" onclick="gAddShop()">Add</button>
      </div>
    </div>
    <div id="g-shop-list"></div>
  </div>

  <!-- RECIPES -->
  <div class="gview" id="gv-rec">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">Recipes</span>
      <button class="gbtn" style="padding:6px 12px;font-size:11px" onclick="openRecModal()">+ New</button>
    </div>
    <div id="g-rec-list"></div>
  </div>
</div>

<!-- Meal modal -->
<div class="modal-ov" id="meal-modal">
  <div class="modal">
    <h2 id="meal-modal-ttl">Meals</h2>
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Breakfast</div>
    <input class="mi" id="mm-b" placeholder="e.g. Oatmeal" /><button class="rpick-btn" onclick="gPickRec('mm-b')">ğŸ“– pick recipe</button>
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:10px 0 4px">Lunch</div>
    <input class="mi" id="mm-l" placeholder="e.g. Sandwiches" /><button class="rpick-btn" onclick="gPickRec('mm-l')">ğŸ“– pick recipe</button>
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:10px 0 4px">Dinner</div>
    <input class="mi" id="mm-d" placeholder="e.g. Pasta" /><button class="rpick-btn" onclick="gPickRec('mm-d')">ğŸ“– pick recipe</button>
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:10px 0 4px">Snack</div>
    <input class="mi" id="mm-s" placeholder="e.g. Fruit..." style="margin-bottom:14px" />
    <div class="mact">
      <button class="msec" onclick="closeMealModal()">Cancel</button>
      <button class="mprim" onclick="saveMealModal()">Save</button>
    </div>
  </div>
</div>
<!-- Recipe modal -->
<div class="modal-ov" id="rec-modal">
  <div class="modal">
    <h2>New Recipe</h2>
    <input class="mi" id="rm-name" placeholder="Recipe name..." />
    <input class="mi" id="rm-tags" placeholder="Tags (chicken, quick, ...)" />
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Ingredients</div>
    <textarea class="mi" id="rm-ing" placeholder="1 cup flour&#10;2 eggs..." style="min-height:70px;resize:none"></textarea>
    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:8px 0 4px">Instructions</div>
    <textarea class="mi" id="rm-inst" placeholder="Steps..." style="min-height:70px;resize:none;margin-bottom:14px"></textarea>
    <div class="mact">
      <button class="msec" onclick="closeRecModal()">Cancel</button>
      <button class="mprim" onclick="saveRecModal()">Save Recipe</button>
    </div>
  </div>
</div>
<!-- Recipe pick modal -->
<div class="modal-ov" id="rpick-modal">
  <div class="modal">
    <h2>Pick a Recipe</h2>
    <div id="rpick-list"></div>
    <div class="mact"><button class="msec" onclick="closeRpick()">Cancel</button></div>
  </div>
</div>
<!-- Add project modal -->
<div class="modal-ov" id="proj-modal">
  <div class="modal">
    <h2>New Project</h2>
    <input class="mi" id="new-proj-name" placeholder="Project name..." maxlength="60" />
    <div class="mact">
      <button class="msec" onclick="closeProjModal()">Cancel</button>
      <button class="mprim" onclick="createProj()">Create</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â• WORDLE â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-wordle">
  <div id="w-header">
    <div id="w-title">Wordle+</div>
    <div id="w-len-tabs">
      <button class="wlen-btn" onclick="wSetLen(3)">3</button>
      <button class="wlen-btn" onclick="wSetLen(4)">4</button>
      <button class="wlen-btn active" onclick="wSetLen(5)">5</button>
      <button class="wlen-btn" onclick="wSetLen(6)">6</button>
      <button class="wlen-btn" onclick="wSetLen(7)">7</button>
      <button class="wlen-btn" onclick="wSetLen(8)">8</button>
    </div>
    <button id="w-stats-btn" onclick="wShowStats()">ğŸ“Š</button>
  </div>
  <div id="w-game">
    <div id="w-msg"></div>
    <div id="w-board-area"><div id="w-board"></div></div>
    <div id="w-keyboard"></div>
    <button id="w-new-btn" onclick="wNewGame()">New Word</button>
  </div>
</div>

<!-- Wordle stats modal -->
<div class="modal-ov" id="w-stats-modal">
  <div class="modal">
    <h2 style="color:var(--accent)">ğŸ“Š Stats â€” <span id="wm-len">5</span> Letters</h2>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;text-align:center">
      <div><div style="font-family:Fraunces,serif;font-size:26px;font-weight:200" id="wm-played">0</div><div style="font-size:10px;color:var(--muted)">Played</div></div>
      <div><div style="font-family:Fraunces,serif;font-size:26px;font-weight:200" id="wm-wins">0</div><div style="font-size:10px;color:var(--muted)">Wins</div></div>
      <div><div style="font-family:Fraunces,serif;font-size:26px;font-weight:200" id="wm-streak">0</div><div style="font-size:10px;color:var(--muted)">Streak</div></div>
      <div><div style="font-family:Fraunces,serif;font-size:26px;font-weight:200" id="wm-best">0</div><div style="font-size:10px;color:var(--muted)">Best</div></div>
    </div>
    <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px">Guess Distribution</div>
    <div id="wm-dist"></div>
    <div class="mact" style="margin-top:14px">
      <button class="msec" onclick="document.getElementById('w-stats-modal').classList.remove('active')">Close</button>
      <button class="mprim" style="background:var(--accent);color:#0e0e10" onclick="document.getElementById('w-stats-modal').classList.remove('active');wNewGame()">New Word</button>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â• CRM â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-crm">
  <!-- Main tabs + views -->
  <div id="crm-main" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
    <div id="crm-tabs">
      <div class="crm-tab active" onclick="crmTab('contacts')">ğŸ‘¤ Contacts</div>
      <div class="crm-tab" onclick="crmTab('queue')">ğŸ”” Follow-up</div>
      <div class="crm-tab" onclick="crmTab('timeline')">ğŸ“‹ Timeline</div>
    </div>

    <!-- CONTACTS VIEW -->
    <div class="crm-view active" id="crm-contacts-view">
      <div id="crm-search-wrap"><input id="crm-search" placeholder="Search contactsâ€¦" oninput="crmRenderList()" /></div>
      <div id="crm-filters">
        <div class="crm-chip active" data-filter="all" onclick="crmSetFilter(this,'all')">All</div>
        <div class="crm-chip" data-filter="friend" onclick="crmSetFilter(this,'friend')">Friends &amp; Family</div>
        <div class="crm-chip" data-filter="pro" onclick="crmSetFilter(this,'pro')">Professional</div>
        <div class="crm-chip" data-filter="client" onclick="crmSetFilter(this,'client')">Clients</div>
      </div>
      <div id="crm-list"></div>
    </div>

    <!-- FOLLOW-UP VIEW -->
    <div class="crm-view" id="crm-queue-view">
      <div id="crm-queue-list"></div>
    </div>

    <!-- TIMELINE VIEW -->
    <div class="crm-view" id="crm-timeline-view">
      <div id="crm-timeline-list"></div>
    </div>

    <button id="crm-add-btn" onclick="crmOpenAddModal()">+</button>
  </div>

  <!-- DETAIL VIEW -->
  <div id="crm-detail">
    <div id="crm-detail-header">
      <button id="crm-back" onclick="crmCloseDetail()">â† back</button>
      <div id="crm-detail-name"></div>
      <button id="crm-detail-del" onclick="crmDeleteContact()">ğŸ—‘</button>
    </div>
    <div id="crm-detail-body"></div>
  </div>
</div>

<!-- Add Contact Modal -->
<div class="modal-ov" id="crm-contact-modal">
  <div class="modal">
    <h2 id="crm-modal-title">New Contact</h2>
    <input class="mi" id="crm-m-name" placeholder="Full name *" />
    <select class="mi" id="crm-m-type" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:9px 10px;font-family:'DM Mono',monospace;font-size:12px">
      <option value="friend">Friend / Family</option>
      <option value="pro">Professional</option>
      <option value="client">Client</option>
    </select>
    <input class="mi" id="crm-m-company" placeholder="Company / Role" />
    <input class="mi" id="crm-m-phone" placeholder="Phone" type="tel" />
    <input class="mi" id="crm-m-email" placeholder="Email" type="email" />
    <input class="mi" id="crm-m-social" placeholder="LinkedIn / Twitter / Website" />
    <div class="mact">
      <button class="msec" onclick="crmCloseContactModal()">Cancel</button>
      <button class="mprim" onclick="crmSaveContactModal()">Save</button>
    </div>
  </div>
</div>

<!-- Log Interaction Modal -->
<div class="modal-ov" id="crm-log-modal">
  <div class="modal">
    <h2>Log Interaction</h2>
    <select class="mi" id="crm-l-type" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:9px 10px;font-family:'DM Mono',monospace;font-size:12px">
      <option value="call">ğŸ“ Phone call</option>
      <option value="text">ğŸ’¬ Text / DM</option>
      <option value="email">âœ‰ï¸ Email</option>
      <option value="meet">ğŸ¤ Met in person</option>
      <option value="other">ğŸ“ Other</option>
    </select>
    <textarea class="mi" id="crm-l-note" placeholder="What happened? Notesâ€¦"></textarea>
    <div class="mact">
      <button class="msec" onclick="crmCloseLogModal()">Cancel</button>
      <button class="mprim" onclick="crmSaveLog()">Save</button>
    </div>
  </div>
</div>

<!-- Follow-up Modal -->
<div class="modal-ov" id="crm-followup-modal">
  <div class="modal">
    <h2>Set Follow-up</h2>
    <input class="mi" id="crm-f-date" type="date" />
    <input class="mi" id="crm-f-action" placeholder="What to do (e.g. Call to check in)" />
    <div class="mact">
      <button class="msec" onclick="document.getElementById('crm-followup-modal').classList.remove('active')">Cancel</button>
      <button class="mprim" onclick="crmSaveFollowup()">Save</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TOWER GAME â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-tower">
  <div id="tower-wrap">
    <div id="g-topbar">
      <div class="gpill"><span>â¤ï¸</span><span id="g-lives">20</span></div>
      <div class="gpill"><span>ğŸ’°</span><span id="g-gold">150</span></div>
      <div class="gpill"><span>ğŸ’€</span><span id="g-kills">0</span></div>
      <div class="gpill"><span>ğŸŒŠ</span><span id="g-wave">0</span></div>
      <span id="g-wave-info">Ready</span>
      <button id="g-set-btn" onclick="gToggleSettings()">âš™ï¸</button>
    </div>
    <div id="canvas-wrap">
      <canvas id="gc"></canvas>
      <div class="g-overlay active" id="g-start">
        <h1 style="color:var(--accent)">âš”ï¸ Fortress</h1>
        <p>Place towers on the map then send waves of enemies. Don't let them reach the end!</p>
        <button class="gbtn2" onclick="gStart()">Start Game</button>
      </div>
      <div class="g-overlay" id="g-over">
        <h1 style="color:var(--danger)">Defeated</h1>
        <p id="g-over-txt"></p>
        <button class="gbtn2" onclick="gRestart()">Try Again</button>
      </div>
      <div class="g-overlay" id="g-win">
        <h1 style="color:var(--accent)">Victory! ğŸ‰</h1>
        <p id="g-win-txt"></p>
        <button class="gbtn2" onclick="gRestart()">Play Again</button>
      </div>
      <div id="g-settings">
        <div style="font-size:11px;font-weight:500;margin-bottom:10px;color:var(--accent2)">Enemy Settings</div>
        <div class="srow"><label>Speed</label><input type="range" min="0.3" max="3" step="0.1" value="1" id="es-spd" oninput="gApplySettings()"><span class="sv" id="ev-spd">1x</span></div>
        <div class="srow"><label>Health</label><input type="range" min="0.25" max="5" step="0.25" value="1" id="es-hp" oninput="gApplySettings()"><span class="sv" id="ev-hp">1x</span></div>
        <div class="srow"><label>Armor</label><input type="range" min="0" max="5" step="0.5" value="0" id="es-arm" oninput="gApplySettings()"><span class="sv" id="ev-arm">0</span></div>
        <div class="srow"><label>Reward</label><input type="range" min="0.5" max="3" step="0.5" value="1" id="es-rew" oninput="gApplySettings()"><span class="sv" id="ev-rew">1x</span></div>
        <div style="font-size:9px;color:var(--muted)">Applies to next wave</div>
      </div>
      <div id="upg-panel">
        <h3 id="upg-ttl">Tower</h3>
        <div id="upg-opts"></div>
        <button class="gbtn2" style="width:100%;margin-top:4px" onclick="closeUpg()">Close</button>
      </div>
    </div>
    <div id="g-bottom">
      <div id="tower-btns"></div>
      <div id="g-actrow">
        <button class="gbtn2 prim" id="g-wave-btn" onclick="gSendWave()">â–¶ Send Wave</button>
        <button class="gbtn2" id="g-spd-btn" onclick="gToggleSpeed()">1x</button>
        <button class="gbtn2" id="g-sell" style="display:none" onclick="gSell()">Sell</button>
        <div id="g-info">Select a tower, tap map to place</div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.mnav').forEach((t,i)=>t.classList.toggle('active',['projects','grocery','tower','wordle','crm'][i]===id));
  document.getElementById('s-'+id).classList.add('active');
  if(id==='grocery'){gRenderInv();gRenderCal();}
  if(id==='tower'){gResizeCanvas();}
  if(id==='wordle'){wInit();}
  if(id==='crm'){crmRender();}
}

function escH(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PSK='pt_v2';
function pLoad(){try{return JSON.parse(localStorage.getItem(PSK))||[]}catch{return[]}}
function pSave(){localStorage.setItem(PSK,JSON.stringify(pProjects))}
let pProjects=pLoad(),pCurId=null;
const PCOLS=['#c8f060','#60c8f0','#f060c8','#f0a060','#a060f0','#60f0a0'];
function pGet(){return pProjects.find(p=>p.id===pCurId)}

function showProjList(){
  document.getElementById('pj-list').classList.add('active');
  document.getElementById('pj-detail').classList.remove('active');
  pCurId=null;pRenderList();
}
function showProjDetail(id){
  pCurId=id;
  document.getElementById('pj-list').classList.remove('active');
  document.getElementById('pj-detail').classList.add('active');
  pRenderDetail();
}

function pRenderList(){
  const body=document.getElementById('proj-list-body');
  const empty=document.getElementById('proj-empty');
  document.getElementById('pj-count').textContent=pProjects.filter(p=>p.status!=='dn').length+' active';
  body.querySelectorAll('.proj-card').forEach(c=>c.remove());
  if(!pProjects.length){empty.style.display='block';return;}
  empty.style.display='none';
  const SL={'ns':'Not Started','ip':'In Progress','dn':'Done','oh':'On Hold'};
  const SC={'ns':'sp-ns','ip':'sp-ip','dn':'sp-dn','oh':'sp-oh'};
  pProjects.forEach(p=>{
    const c=document.createElement('div');c.className='proj-card';
    c.style.setProperty('--card-color',p.color);
    c.innerHTML=`<div class="card-top"><div class="card-name">${escH(p.name)}</div><div class="spill ${SC[p.status]}">${SL[p.status]}</div></div><div class="card-meta"><span>âœ“ ${p.tasks.filter(t=>t.done).length}/${p.tasks.length}</span>${p.links.length?`<span>âŒ ${p.links.length}</span>`:''}${p.notes.trim()?'<span>âœ</span>':''}</div>`;
    c.onclick=()=>showProjDetail(p.id);
    body.insertBefore(c,document.getElementById('proj-empty'));
  });
}

function pRenderDetail(){
  const p=pGet();if(!p)return;
  document.getElementById('pj-name-hdr').textContent=p.name;
  document.querySelectorAll('.st-btn').forEach(b=>{b.className='st-btn';if(b.dataset.s===p.status)b.classList.add('a-'+p.status)});
  document.getElementById('pj-notes').value=p.notes;
  pRenderTasks();pRenderLinks();
}

function pRenderTasks(){
  const p=pGet();if(!p)return;
  const list=document.getElementById('pj-tasks-list');list.innerHTML='';
  p.tasks.forEach((t,i)=>{
    const el=document.createElement('div');el.className='t-item';
    el.innerHTML=`<div class="t-chk ${t.done?'chk':''}" data-i="${i}">${t.done?'âœ“':''}</div><input class="t-inp ${t.done?'done':''}" value="${escH(t.text)}" placeholder="Task..." data-i="${i}"/><button class="xbtn" data-i="${i}">Ã—</button>`;
    list.appendChild(el);
  });
  list.querySelectorAll('.t-chk').forEach(b=>b.onclick=()=>{const p=pGet();p.tasks[+b.dataset.i].done=!p.tasks[+b.dataset.i].done;pSave();pRenderTasks()});
  list.querySelectorAll('.t-inp').forEach(inp=>inp.oninput=()=>{pGet().tasks[+inp.dataset.i].text=inp.value;pSave()});
  list.querySelectorAll('.xbtn').forEach(b=>b.onclick=()=>{pGet().tasks.splice(+b.dataset.i,1);pSave();pRenderTasks()});
}

function pRenderLinks(){
  const p=pGet();if(!p)return;
  const list=document.getElementById('pj-links-list');list.innerHTML='';
  p.links.forEach((lk,i)=>{
    const el=document.createElement('div');el.className='l-item';
    el.innerHTML=`<span style="font-size:13px;flex-shrink:0">âŒ</span><div class="l-ins"><input class="l-inp" value="${escH(lk.label)}" placeholder="Label..." data-i="${i}" data-f="label"/><input class="l-inp url" value="${escH(lk.url)}" placeholder="https://..." data-i="${i}" data-f="url"/></div><button class="xbtn" data-i="${i}">Ã—</button>`;
    list.appendChild(el);
  });
  list.querySelectorAll('.l-inp').forEach(inp=>inp.oninput=()=>{pGet().links[+inp.dataset.i][inp.dataset.f]=inp.value;pSave()});
  list.querySelectorAll('.xbtn').forEach(b=>b.onclick=()=>{pGet().links.splice(+b.dataset.i,1);pSave();pRenderLinks()});
}

function openProjModal(){document.getElementById('new-proj-name').value='';document.getElementById('proj-modal').classList.add('active');setTimeout(()=>document.getElementById('new-proj-name').focus(),100)}
function closeProjModal(){document.getElementById('proj-modal').classList.remove('active')}
document.getElementById('proj-modal').onclick=e=>{if(e.target===document.getElementById('proj-modal'))closeProjModal()}
document.getElementById('new-proj-name').onkeydown=e=>{if(e.key==='Enter')createProj()}

function createProj(){
  const name=document.getElementById('new-proj-name').value.trim();if(!name)return;
  const p={id:Date.now().toString(),name,status:'ns',notes:'',tasks:[],links:[],color:PCOLS[pProjects.length%PCOLS.length]};
  pProjects.unshift(p);pSave();closeProjModal();showProjDetail(p.id);
}

function delProj(){
  const p=pGet();if(!p)return;
  if(confirm('Delete "'+p.name+'"?')){pProjects=pProjects.filter(x=>x.id!==pCurId);pSave();showProjList()}
}

document.querySelectorAll('.st-btn').forEach(b=>b.onclick=()=>{
  const p=pGet();if(!p)return;p.status=b.dataset.s;pSave();
  document.querySelectorAll('.st-btn').forEach(x=>{x.className='st-btn';if(x.dataset.s===p.status)x.classList.add('a-'+p.status)});
});
document.getElementById('pj-notes').oninput=()=>{const p=pGet();if(p){p.notes=document.getElementById('pj-notes').value;pSave()}};
document.getElementById('pj-add-task').onclick=()=>{const p=pGet();if(!p)return;p.tasks.push({text:'',done:false});pSave();pRenderTasks();const ins=document.querySelectorAll('#pj-tasks-list .t-inp');if(ins.length)ins[ins.length-1].focus()};
document.getElementById('pj-add-link').onclick=()=>{const p=pGet();if(!p)return;p.links.push({label:'',url:''});pSave();pRenderLinks()};

pRenderList();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROCERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GSK='grocery_v2';
function gLoad(){try{return JSON.parse(localStorage.getItem(GSK))||gDefault()}catch{return gDefault()}}
function gDefault(){return{inventory:{'Kitchen Fridge':[],'Kitchen Freezer':[],'Pantry':[],'Garage Fridge':[],'Garage Freezer':[],'Deep Freeze':[]},meals:{},shopping:[],recipes:[]}}
function gSave(){localStorage.setItem(GSK,JSON.stringify(gdb))}
let gdb=gLoad(),gLoc='Kitchen Fridge',gCalView='month',gCalOff=0,gMealKey=null,gRpickTarget=null;

function gTab(t){
  document.querySelectorAll('.gtab').forEach((x,i)=>x.classList.toggle('active',['inv','cal','shop','rec'][i]===t));
  document.querySelectorAll('.gview').forEach(v=>v.classList.remove('active'));
  document.getElementById('gv-'+t).classList.add('active');
  if(t==='cal')gRenderCal();
  if(t==='shop')gRenderShop();
  if(t==='rec')gRenderRec();
}

// INVENTORY
function gRenderInv(){
  const locs=Object.keys(gdb.inventory);
  const lt=document.getElementById('g-loc-tabs');lt.innerHTML='';
  locs.forEach(loc=>{
    const b=document.createElement('button');b.className='loc-btn'+(loc===gLoc?' active':'');
    b.textContent=loc;b.onclick=()=>{gLoc=loc;gRenderInv()};lt.appendChild(b);
  });
  const items=gdb.inventory[gLoc]||[];
  const il=document.getElementById('g-items-list');il.innerHTML='';
  if(!items.length){il.innerHTML='<div style="color:var(--muted);padding:6px 0;font-size:11px">No items yet.</div>';return;}
  items.forEach((item,i)=>{
    const row=document.createElement('div');row.className='item-row';
    row.innerHTML=`<span class="iname">${escH(item.name)}</span><input class="iqty" type="number" min="0" value="${item.qty}" onchange="gUpdQty(${i},this.value)"/><input class="iunit" value="${escH(item.unit||'')}" placeholder="unit" onchange="gUpdUnit(${i},this.value)"/>${item.qty<=1?'<span class="ilow">low</span>':''}<button class="xbtn" onclick="gDelItem(${i})">Ã—</button>`;
    il.appendChild(row);
  });
}
function gAddItem(){
  const name=document.getElementById('g-iname').value.trim();if(!name)return;
  gdb.inventory[gLoc].push({name,qty:parseFloat(document.getElementById('g-iqty').value)||0,unit:document.getElementById('g-iunit').value.trim()});
  gSave();['g-iname','g-iqty','g-iunit'].forEach(id=>document.getElementById(id).value='');gRenderInv();
}
function gUpdQty(i,v){gdb.inventory[gLoc][i].qty=parseFloat(v)||0;gSave();gRenderInv()}
function gUpdUnit(i,v){gdb.inventory[gLoc][i].unit=v;gSave()}
function gDelItem(i){gdb.inventory[gLoc].splice(i,1);gSave();gRenderInv()}

// CALENDAR
function gSetCalView(v){
  gCalView=v;
  document.getElementById('g-btn-month').style.borderColor=v==='month'?'var(--accent)':'var(--border)';
  document.getElementById('g-btn-2wk').style.borderColor=v==='twoweek'?'var(--accent)':'var(--border)';
  gRenderCal();
}
function gNavCal(d){gCalOff+=d;gRenderCal()}
function gDK(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function gSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}

function gRenderCal(){
  const today=new Date();
  if(gCalView==='month'){
    const base=new Date(today.getFullYear(),today.getMonth()+gCalOff,1);
    document.getElementById('g-cal-title').textContent=base.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    gRenderMonth(base);
  } else {
    const start=new Date(today);start.setDate(start.getDate()+gCalOff*14);
    document.getElementById('g-cal-title').textContent='2-Week View';
    gRenderTwoWeek(start);
  }
}

function gRenderMonth(base){
  const today=new Date(),year=base.getFullYear(),month=base.getMonth();
  const firstDay=new Date(year,month,1).getDay(),dim=new Date(year,month+1,0).getDate();
  let html='<div class="cal-grid">';
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>html+=`<div class="cdname">${d}</div>`);
  for(let i=0;i<firstDay;i++){const d=new Date(year,month,-(firstDay-i-1));html+=`<div class="cday om"><div class="cday-n">${d.getDate()}</div></div>`}
  for(let d=1;d<=dim;d++){
    const date=new Date(year,month,d),key=gDK(date),isT=gSameDay(date,today);
    const m=gdb.meals[key]||{};
    let mh='';
    if(m.breakfast)mh+=`<div class="cmeal">${escH(m.breakfast.substring(0,10))}</div>`;
    if(m.lunch)mh+=`<div class="cmeal lunch">${escH(m.lunch.substring(0,10))}</div>`;
    if(m.dinner)mh+=`<div class="cmeal dinner">${escH(m.dinner.substring(0,10))}</div>`;
    html+=`<div class="cday${isT?' tod':''}" onclick="gOpenMealModal('${key}')"><div class="cday-n">${d}</div>${mh}</div>`;
  }
  html+='</div>';
  document.getElementById('g-cal-container').innerHTML=html;
}

function gRenderTwoWeek(start){
  const today=new Date();let html='';
  for(let i=0;i<14;i++){
    const date=new Date(start);date.setDate(start.getDate()+i);
    const key=gDK(date),m=gdb.meals[key]||{},isT=gSameDay(date,today);
    html+=`<div class="twrow"><div class="twdate"><div class="dn">${date.toLocaleDateString('en-US',{weekday:'short'})}</div><div class="dd" style="color:${isT?'var(--accent)':'var(--text)'}">${date.getDate()}</div><div class="dn" style="font-size:9px">${date.toLocaleDateString('en-US',{month:'short'})}</div></div><div class="twmeals">
    ${['breakfast','lunch','dinner','snack'].map(t=>`<div class="mslot"><span class="mlabel">${t}</span><input class="mval" value="${escH(m[t]||'')}" placeholder="..." data-key="${key}" data-type="${t}"/><button class="rpick-btn" data-inp-key="${key}" data-inp-type="${t}">ğŸ“–</button></div>`).join('')}
    </div></div>`;
  }
  const c=document.getElementById('g-cal-container');c.innerHTML=html;
  c.querySelectorAll('.mval').forEach(inp=>inp.onchange=()=>{
    if(!gdb.meals[inp.dataset.key])gdb.meals[inp.dataset.key]={};
    gdb.meals[inp.dataset.key][inp.dataset.type]=inp.value;gSave();
  });
  c.querySelectorAll('.rpick-btn').forEach(btn=>btn.onclick=()=>{
    gRpickTarget={key:btn.dataset.inpKey,type:btn.dataset.inpType,field:null};gOpenRpick();
  });
}

function gOpenMealModal(key){
  gMealKey=key;const d=new Date(key);
  document.getElementById('meal-modal-ttl').textContent='Meals â€” '+d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
  const m=gdb.meals[key]||{};
  document.getElementById('mm-b').value=m.breakfast||'';
  document.getElementById('mm-l').value=m.lunch||'';
  document.getElementById('mm-d').value=m.dinner||'';
  document.getElementById('mm-s').value=m.snack||'';
  document.getElementById('meal-modal').classList.add('active');
}
function closeMealModal(){document.getElementById('meal-modal').classList.remove('active')}
function saveMealModal(){
  if(!gMealKey)return;
  if(!gdb.meals[gMealKey])gdb.meals[gMealKey]={};
  gdb.meals[gMealKey].breakfast=document.getElementById('mm-b').value;
  gdb.meals[gMealKey].lunch=document.getElementById('mm-l').value;
  gdb.meals[gMealKey].dinner=document.getElementById('mm-d').value;
  gdb.meals[gMealKey].snack=document.getElementById('mm-s').value;
  gSave();closeMealModal();gRenderCal();
}

function gPickRec(fieldId){gRpickTarget={fieldId};gOpenRpick()}
function gOpenRpick(){
  const list=document.getElementById('rpick-list');list.innerHTML='';
  if(!gdb.recipes.length){list.innerHTML='<div style="color:var(--muted)">No recipes yet.</div>';document.getElementById('rpick-modal').classList.add('active');return;}
  gdb.recipes.forEach(r=>{
    const b=document.createElement('button');
    b.style.cssText='display:block;width:100%;text-align:left;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:9px 12px;color:var(--text);font-family:DM Mono,monospace;font-size:12px;cursor:pointer;margin-bottom:7px';
    b.textContent=r.name;
    b.onclick=()=>{
      if(gRpickTarget){
        if(gRpickTarget.fieldId){
          const el=document.getElementById(gRpickTarget.fieldId);if(el)el.value=r.name;
        } else if(gRpickTarget.key){
          if(!gdb.meals[gRpickTarget.key])gdb.meals[gRpickTarget.key]={};
          gdb.meals[gRpickTarget.key][gRpickTarget.type]=r.name;gSave();gRenderCal();
        }
      }
      closeRpick();
    };
    list.appendChild(b);
  });
  document.getElementById('rpick-modal').classList.add('active');
}
function closeRpick(){document.getElementById('rpick-modal').classList.remove('active')}

// SHOPPING
function gRenderShop(){
  const c=document.getElementById('g-shop-list');
  if(!gdb.shopping.length){c.innerHTML='<div style="color:var(--muted);font-size:11px">No items. Add manually or auto-generate from meal plan.</div>';return;}
  const byStore={};
  gdb.shopping.forEach((item,i)=>{const s=item.store||'General';if(!byStore[s])byStore[s]=[];byStore[s].push({...item,idx:i})});
  c.innerHTML='';
  Object.keys(byStore).forEach(store=>{
    const div=document.createElement('div');
    let html=`<div style="font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin:10px 0 4px">${escH(store)}</div>`;
    byStore[store].forEach(item=>{
      html+=`<div class="shop-item"><div class="schk${item.checked?' chk':''}" onclick="gTogShop(${item.idx})">${item.checked?'âœ“':''}</div><span class="sname${item.checked?' done':''}">${escH(item.name)}</span>${item.detail?`<span class="sdet">${escH(item.detail)}</span>`:''}<button class="xbtn" onclick="gDelShop(${item.idx})">Ã—</button></div>`;
    });
    div.innerHTML=html;c.appendChild(div);
  });
}
function gAddShop(){
  const name=document.getElementById('g-sname').value.trim();if(!name)return;
  gdb.shopping.push({name,store:document.getElementById('g-sstore').value,checked:false});
  gSave();document.getElementById('g-sname').value='';gRenderShop();
}
function gTogShop(i){gdb.shopping[i].checked=!gdb.shopping[i].checked;gSave();gRenderShop()}
function gDelShop(i){gdb.shopping.splice(i,1);gSave();gRenderShop()}
function gGenShop(){
  const today=new Date();const added=new Set(gdb.shopping.map(s=>s.name.toLowerCase()));let count=0;
  for(let i=0;i<14;i++){
    const d=new Date(today);d.setDate(today.getDate()+i);
    const m=gdb.meals[gDK(d)];if(!m)continue;
    ['breakfast','lunch','dinner','snack'].forEach(t=>{
      if(!m[t])return;
      const rec=gdb.recipes.find(r=>r.name.toLowerCase()===m[t].toLowerCase());
      if(rec&&rec.ingredients){rec.ingredients.split('\n').forEach(line=>{const ing=line.trim();if(ing&&!added.has(ing.toLowerCase())){gdb.shopping.push({name:ing,store:'Grocery',checked:false,detail:'for '+m[t]});added.add(ing.toLowerCase());count++;}})}
    });
  }
  gSave();gRenderShop();alert(count?'Added '+count+' ingredients!':'No new ingredients found. Make sure meal names match recipe names exactly.');
}

// RECIPES
function gRenderRec(){
  const c=document.getElementById('g-rec-list');
  if(!gdb.recipes.length){c.innerHTML='<div style="color:var(--muted);font-size:11px">No recipes yet.</div>';return;}
  c.innerHTML='';
  gdb.recipes.forEach((r,i)=>{
    const card=document.createElement('div');card.className='rec-card';
    const tags=(r.tags||'').split(',').filter(Boolean).map(t=>`<span class="rtag">${escH(t.trim())}</span>`).join(' ');
    card.innerHTML=`<div class="rec-hdr" onclick="gTogRec(${i})"><div class="rec-name">${escH(r.name)}</div><button class="xbtn" onclick="event.stopPropagation();gDelRec(${i})">Ã—</button></div><div class="rec-body" id="rb-${i}">${tags?`<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px">${tags}</div>`:''}
      <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:10px 0 3px">Ingredients</div>
      <textarea class="rec-ta" onchange="gUpdRec(${i},'ingredients',this.value)">${escH(r.ingredients||'')}</textarea>
      <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin:8px 0 3px">Instructions</div>
      <textarea class="rec-ta" onchange="gUpdRec(${i},'instructions',this.value)">${escH(r.instructions||'')}</textarea>
    </div>`;
    c.appendChild(card);
  });
}
function gTogRec(i){document.getElementById('rb-'+i).classList.toggle('open')}
function gUpdRec(i,f,v){gdb.recipes[i][f]=v;gSave()}
function gDelRec(i){if(confirm('Delete recipe?')){gdb.recipes.splice(i,1);gSave();gRenderRec()}}
function openRecModal(){document.getElementById('rec-modal').classList.add('active')}
function closeRecModal(){document.getElementById('rec-modal').classList.remove('active')}
function saveRecModal(){
  const name=document.getElementById('rm-name').value.trim();if(!name)return;
  gdb.recipes.push({name,tags:document.getElementById('rm-tags').value,ingredients:document.getElementById('rm-ing').value,instructions:document.getElementById('rm-inst').value});
  gSave();closeRecModal();['rm-name','rm-tags','rm-ing','rm-inst'].forEach(id=>document.getElementById(id).value='');gRenderRec();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOWER DEFENSE GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TD={
  towers:[
    {id:'archer',name:'Archer',icon:'ğŸ¹',cost:50,color:'#60f0a0',range:90,fireRate:60,damage:15,type:'single'},
    {id:'cannon',name:'Cannon',icon:'ğŸ’£',cost:100,color:'#f0a060',range:80,fireRate:120,damage:60,splash:40,type:'splash'},
    {id:'freeze',name:'Frost',icon:'â„ï¸',cost:80,color:'#60c8f0',range:85,fireRate:80,damage:5,slowFactor:.4,slowDur:90,type:'slow'},
    {id:'laser',name:'Laser',icon:'âš¡',cost:150,color:'#f060f0',range:120,fireRate:20,damage:8,type:'chain',chainCount:3},
    {id:'sniper',name:'Sniper',icon:'ğŸ¯',cost:120,color:'#f06060',range:200,fireRate:180,damage:120,type:'single'},
    {id:'mortar',name:'Mortar',icon:'ğŸ”¥',cost:130,color:'#ffaa00',range:160,fireRate:200,damage:80,splash:60,type:'splash'},
  ],
  upgrades:{
    archer:[{name:'Sharp Tips',desc:'+50% dmg',cost:75,a:t=>t.damage*=1.5},{name:'Rapid Fire',desc:'+40% rate',cost:100,a:t=>t.fireRate=Math.max(10,t.fireRate*.6)},{name:'Long Range',desc:'+30% range',cost:80,a:t=>t.range*=1.3}],
    cannon:[{name:'Big Shells',desc:'+60% dmg',cost:120,a:t=>t.damage*=1.6},{name:'Wide Blast',desc:'+50% splash',cost:100,a:t=>t.splash*=1.5},{name:'Auto Reload',desc:'+35% rate',cost:90,a:t=>t.fireRate=Math.max(30,t.fireRate*.65)}],
    freeze:[{name:'Deep Cold',desc:'Stronger slow',cost:90,a:t=>t.slowFactor=Math.max(.1,t.slowFactor-.15)},{name:'Flash Freeze',desc:'+50% duration',cost:80,a:t=>t.slowDur*=1.5},{name:'Cryo Blast',desc:'+40% range',cost:100,a:t=>t.range*=1.4}],
    laser:[{name:'Amplifier',desc:'+1 chain',cost:120,a:t=>t.chainCount++},{name:'Overcharge',desc:'+70% dmg',cost:110,a:t=>t.damage*=1.7},{name:'Focus Lens',desc:'+25% range',cost:80,a:t=>t.range*=1.25}],
    sniper:[{name:'Armor Pierce',desc:'Ignore armor',cost:150,a:t=>t.pierceArmor=true},{name:'Hollow Point',desc:'+80% dmg',cost:130,a:t=>t.damage*=1.8},{name:'Eagle Eye',desc:'+40% range',cost:100,a:t=>t.range*=1.4}],
    mortar:[{name:'Napalm',desc:'Burn DoT',cost:140,a:t=>{t.burnDmg=5;t.burnDur=90}},{name:'Cluster',desc:'+80% splash',cost:120,a:t=>t.splash*=1.8},{name:'Long Barrel',desc:'+30% range',cost:90,a:t=>t.range*=1.3}],
  },
  waves:[
    {count:8,hp:60,speed:60,reward:12,color:'#f06060',size:10,armor:0},
    {count:10,hp:80,speed:70,reward:15,color:'#f08060',size:11,armor:0},
    {count:8,hp:50,speed:110,reward:18,color:'#60f080',size:8,armor:0},
    {count:12,hp:120,speed:65,reward:18,color:'#f06060',size:12,armor:0},
    {count:6,hp:200,speed:50,reward:30,color:'#8888ff',size:14,armor:2},
    {count:10,hp:80,speed:130,reward:22,color:'#60f060',size:9,armor:0},
    {count:15,hp:160,speed:70,reward:20,color:'#f06060',size:12,armor:0},
    {count:5,hp:600,speed:45,reward:80,color:'#ff3333',size:18,armor:3},
    {count:12,hp:250,speed:55,reward:35,color:'#9988ff',size:14,armor:4},
    {count:20,hp:100,speed:140,reward:25,color:'#60ff60',size:9,armor:0},
    {count:8,hp:900,speed:50,reward:100,color:'#dd2222',size:20,armor:5},
    {count:25,hp:60,speed:120,reward:12,color:'#ffcc00',size:7,armor:0},
    {count:10,hp:400,speed:60,reward:50,color:'#7766ff',size:16,armor:6},
    {count:5,hp:2000,speed:40,reward:200,color:'#ff0000',size:24,armor:8},
    {count:30,hp:300,speed:90,reward:40,color:'#ff44aa',size:11,armor:2},
  ]
};

const GC=document.getElementById('gc');
const gctx=GC.getContext('2d');
let GW=0,GH=0,PATH=[];
let gState='idle',gLives=20,gGold=150,gKills=0,gWaveNum=0;
let gTowers=[],gEnemies=[],gBullets=[],gParts=[];
let gSelType='archer',gSelTower=null;
let gFrameId=null,gLastT=0,gSpeed=1,gWaveActive=false;
let gSpawnQ=[],gSpawnT=0;
let gES={speed:1,hp:1,armor:0,reward:1};

function gResizeCanvas(){
  const wrap=document.getElementById('canvas-wrap');
  GW=wrap.clientWidth;GH=wrap.clientHeight;
  GC.width=GW;GC.height=GH;
  gBuildPath();
  if(gState==='idle')gDrawStatic();
}

function gBuildPath(){
  const pts=[[0,.25],[.15,.25],[.15,.75],[.35,.75],[.35,.35],[.55,.35],[.55,.65],[.72,.65],[.72,.2],[.88,.2],[.88,.8],[1.05,.8]];
  PATH=pts.map(([x,y])=>({x:x*GW,y:y*GH}));
}

function gBuildTowerBtns(){
  const c=document.getElementById('tower-btns');c.innerHTML='';
  TD.towers.forEach(def=>{
    const b=document.createElement('div');b.className='tbtn'+(def.id===gSelType?' sel':'');
    b.innerHTML=`<span class="ti">${def.icon}</span><span class="tn">${def.name}</span><span class="tc">ğŸ’°${def.cost}</span>`;
    b.onclick=()=>{gSelType=def.id;gSelTower=null;closeUpg();gBuildTowerBtns();document.getElementById('g-info').textContent=def.name+' | ğŸ’°'+def.cost;document.getElementById('g-sell').style.display='none'};
    c.appendChild(b);
  });
}

function gStart(){
  document.getElementById('g-start').classList.remove('active');
  gLives=20;gGold=150;gKills=0;gWaveNum=0;
  gTowers=[];gEnemies=[];gBullets=[];gParts=[];
  gWaveActive=false;gSpawnQ=[];gSpawnT=0;gState='running';
  gUpdHUD();gBuildTowerBtns();gLoop(0);
}
function gRestart(){
  document.getElementById('g-over').classList.remove('active');
  document.getElementById('g-win').classList.remove('active');
  cancelAnimationFrame(gFrameId);gStart();
}

function gSendWave(){
  if(gWaveActive)return;
  if(gWaveNum>=TD.waves.length){gEndGame(true);return;}
  const w=TD.waves[gWaveNum];gWaveNum++;
  document.getElementById('g-wave').textContent=gWaveNum;
  document.getElementById('g-wave-info').textContent='Wave '+gWaveNum;
  for(let i=0;i<w.count;i++)gSpawnQ.push({...w,delay:i*22});
  gWaveActive=true;
  document.getElementById('g-wave-btn').disabled=true;
  document.getElementById('g-wave-btn').textContent='â–¶ In Progress';
}

function gEndGame(win){
  gState=win?'win':'over';cancelAnimationFrame(gFrameId);
  if(win){document.getElementById('g-win-txt').textContent=`Cleared all ${gWaveNum} waves! Kills: ${gKills}`;document.getElementById('g-win').classList.add('active')}
  else{document.getElementById('g-over-txt').textContent=`Survived ${gWaveNum} waves â€¢ ${gKills} enemies down`;document.getElementById('g-over').classList.add('active')}
}

function gToggleSpeed(){const s=[1,2,3];const i=(s.indexOf(gSpeed)+1)%s.length;gSpeed=s[i];document.getElementById('g-spd-btn').textContent=gSpeed+'x'}
function gToggleSettings(){document.getElementById('g-settings').classList.toggle('open');closeUpg()}
function gApplySettings(){
  ['spd','hp','arm','rew'].forEach((k,i)=>{
    const ids=['speed','hp','armor','reward'];const labels=['x','x','','x'];
    const v=parseFloat(document.getElementById('es-'+k).value);
    gES[ids[i]]=v;document.getElementById('ev-'+k).textContent=v+labels[i];
  });
}

// Canvas input
GC.addEventListener('click',e=>{
  if(gState!=='running')return;
  const rect=GC.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(GW/rect.width),y=(e.clientY-rect.top)*(GH/rect.height);
  const clicked=gTowers.find(t=>gDist(t.x,t.y,x,y)<20);
  if(clicked){gSelTower=clicked;gOpenUpg(clicked);document.getElementById('g-sell').style.display='block';return;}
  const def=TD.towers.find(d=>d.id===gSelType);if(!def)return;
  if(gGold<def.cost){document.getElementById('g-info').textContent='Not enough gold!';return;}
  if(gOnPath(x,y)){document.getElementById('g-info').textContent='Cannot place on path!';return;}
  if(gTowers.find(t=>gDist(t.x,t.y,x,y)<22)){document.getElementById('g-info').textContent='Too close to another tower!';return;}
  gGold-=def.cost;
  gTowers.push({...JSON.parse(JSON.stringify(def)),x,y,cooldown:0,level:1,upgrades:[],burnDmg:0,burnDur:0,pierceArmor:false});
  gUpdHUD();document.getElementById('g-sell').style.display='none';closeUpg();gSelTower=null;
});

function gOnPath(x,y){for(let i=0;i<PATH.length-1;i++)if(gSegDist(x,y,PATH[i],PATH[i+1])<20)return true;return false}
function gSegDist(px,py,a,b){const dx=b.x-a.x,dy=b.y-a.y,t=Math.max(0,Math.min(1,((px-a.x)*dx+(py-a.y)*dy)/(dx*dx+dy*dy)));return Math.hypot(px-a.x-t*dx,py-a.y-t*dy)}
function gSell(){if(!gSelTower)return;const def=TD.towers.find(d=>d.id===gSelTower.id);gGold+=Math.floor(def.cost*.6);gTowers=gTowers.filter(t=>t!==gSelTower);gSelTower=null;closeUpg();document.getElementById('g-sell').style.display='none';gUpdHUD()}

function gOpenUpg(tower){
  const def=TD.towers.find(d=>d.id===tower.id);
  document.getElementById('upg-ttl').textContent=`${def.icon} ${def.name} Lv.${tower.level}`;
  const c=document.getElementById('upg-opts');c.innerHTML='';
  (TD.upgrades[tower.id]||[]).forEach((upg,i)=>{
    const bought=tower.upgrades.includes(i);
    const b=document.createElement('button');b.className='upg-btn';b.disabled=bought||(gGold<upg.cost);
    b.innerHTML=`${bought?'âœ“ ':''}<b>${upg.name}</b> â€” ${upg.desc} <span class="upg-cost">${bought?'âœ“':'ğŸ’°'+upg.cost}</span>`;
    if(!bought)b.onclick=()=>{if(gGold<upg.cost)return;gGold-=upg.cost;upg.a(tower);tower.upgrades.push(i);tower.level++;gUpdHUD();gOpenUpg(tower)};
    c.appendChild(b);
  });
  document.getElementById('upg-panel').classList.add('open');
  document.getElementById('g-settings').classList.remove('open');
}
function closeUpg(){document.getElementById('upg-panel').classList.remove('open')}

// GAME LOOP
function gLoop(ts){
  if(gState!=='running')return;
  const dt=Math.min((ts-gLastT)/16.67,4)*gSpeed;gLastT=ts;
  gUpdate(dt);gDraw();gFrameId=requestAnimationFrame(gLoop);
}

function gUpdate(dt){
  // Spawning
  if(gWaveActive&&gSpawnQ.length){
    gSpawnT+=dt;
    while(gSpawnQ.length&&gSpawnT>=gSpawnQ[0].delay/gSpeed){const d=gSpawnQ.shift();gSpawnEnemy(d)}
  }
  // Wave complete
  if(gWaveActive&&!gSpawnQ.length&&!gEnemies.length){
    gWaveActive=false;gGold+=25;
    document.getElementById('g-wave-btn').disabled=false;
    document.getElementById('g-wave-btn').textContent=gWaveNum>=TD.waves.length?'â–¶ Final!':'â–¶ Wave '+(gWaveNum+1);
    document.getElementById('g-wave-info').textContent='Wave '+gWaveNum+' Clear! +25ğŸ’°';
    gUpdHUD();if(gWaveNum>=TD.waves.length)setTimeout(()=>gEndGame(true),1500);
  }
  // Move enemies
  gEnemies.forEach(e=>{
    if(e.dead)return;
    const spd=(e.slowed>0?e.speed*e.slowFactor:e.speed)*gES.speed*dt/60;
    let rem=spd;
    while(rem>0&&e.pi<PATH.length-1){
      const tg=PATH[e.pi+1],dx=tg.x-e.x,dy=tg.y-e.y,d=Math.hypot(dx,dy);
      if(d<=rem){e.x=tg.x;e.y=tg.y;e.pi++;rem-=d}else{e.x+=dx/d*rem;e.y+=dy/d*rem;rem=0}
    }
    if(e.pi>=PATH.length-1){e.dead=true;gLives--;gUpdHUD();if(gLives<=0)gEndGame(false)}
    if(e.slowed>0)e.slowed-=dt;
    if(e.burning>0){e.burning-=dt;e.hp-=e.burnRate*dt/60}
    if(e.hp<=0)gKillEnemy(e);
  });
  // Towers shoot
  gTowers.forEach(t=>{
    t.cooldown-=dt;if(t.cooldown>0)return;
    const ir=gEnemies.filter(e=>!e.dead&&gDist(t.x,t.y,e.x,e.y)<=t.range);
    if(!ir.length)return;
    ir.sort((a,b)=>b.pi-a.pi);
    if(t.type==='single'||t.type==='slow'){
      const tg=ir[0];gFireBullet(t,tg);
      if(t.type==='slow'){tg.slowed=t.slowDur;tg.slowFactor=t.slowFactor}
    } else if(t.type==='splash'){gFireBullet(t,ir[0])}
    else if(t.type==='chain'){
      const hit=new Set();let cur=ir[0];
      for(let i=0;i<Math.min(t.chainCount,ir.length);i++){
        if(!cur)break;gDmgEnemy(cur,t.damage,t);gAddPart(cur.x,cur.y,t.color);hit.add(cur);
        cur=ir.filter(e=>!hit.has(e)&&gDist(cur.x,cur.y,e.x,e.y)<80)[0]||null;
      }
    }
    t.cooldown=t.fireRate;
  });
  // Move bullets
  gBullets.forEach(b=>{
    b.life-=dt;
    if(b.target&&!b.target.dead){
      const dx=b.target.x-b.x,dy=b.target.y-b.y,d=Math.hypot(dx,dy);
      if(d<b.spd*dt+b.target.size){
        if(b.splash){gEnemies.forEach(e=>{if(!e.dead&&gDist(b.x,b.y,e.x,e.y)<=b.splash){gDmgEnemy(e,b.dmg,b.tower);if(b.tower.burnDmg){e.burning=b.tower.burnDur;e.burnRate=b.tower.burnDmg}}});gAddPart(b.x,b.y,b.color,true)}
        else gDmgEnemy(b.target,b.dmg,b.tower);
        b.life=0;
      } else{b.x+=dx/d*b.spd*dt;b.y+=dy/d*b.spd*dt}
    } else b.life=0;
  });
  gBullets=gBullets.filter(b=>b.life>0);
  gParts=gParts.filter(p=>{p.life-=dt;p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=.3*dt;return p.life>0});
  gEnemies=gEnemies.filter(e=>!e.dead);
}

function gSpawnEnemy(d){
  gEnemies.push({x:PATH[0].x,y:PATH[0].y,pi:0,hp:d.hp*gES.hp,maxHp:d.hp*gES.hp,speed:d.speed,slowFactor:.5,reward:Math.round(d.reward*gES.reward),armor:(d.armor||0)+gES.armor,color:d.color,size:d.size,dead:false,slowed:0,burning:0,burnRate:0});
}
function gDmgEnemy(e,dmg,tower){const ar=tower&&tower.pierceArmor?0:e.armor||0;e.hp-=Math.max(1,dmg-ar);if(e.hp<=0)gKillEnemy(e)}
function gKillEnemy(e){if(e.dead)return;e.dead=true;gKills++;gGold+=e.reward;for(let i=0;i<6;i++)gAddPart(e.x,e.y,e.color);gUpdHUD()}
function gFireBullet(tower,target){gBullets.push({x:tower.x,y:tower.y,spd:10,target,dmg:tower.damage,splash:tower.splash||0,color:tower.color,life:tower.range/10*2,tower})}
function gAddPart(x,y,color,big=false){const n=big?8:4;for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=big?3+Math.random()*4:1+Math.random()*3;gParts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,color,life:big?30:20,maxLife:big?30:20})}}
function gUpdHUD(){document.getElementById('g-lives').textContent=gLives;document.getElementById('g-gold').textContent=gGold;document.getElementById('g-kills').textContent=gKills}
function gDist(ax,ay,bx,by){return Math.hypot(ax-bx,ay-by)}

// DRAW
function gDraw(){
  gctx.clearRect(0,0,GW,GH);
  gDrawBG();gDrawPath();gDrawRanges();gDrawTowers();gDrawEnemies();gDrawBullets();gDrawParts();
}
function gDrawStatic(){gctx.clearRect(0,0,GW,GH);gDrawBG();gDrawPath()}

function gDrawBG(){
  gctx.fillStyle='#0a0c10';gctx.fillRect(0,0,GW,GH);
  gctx.strokeStyle='rgba(255,255,255,.025)';gctx.lineWidth=1;
  for(let x=0;x<GW;x+=40){gctx.beginPath();gctx.moveTo(x,0);gctx.lineTo(x,GH);gctx.stroke()}
  for(let y=0;y<GH;y+=40){gctx.beginPath();gctx.moveTo(0,y);gctx.lineTo(GW,y);gctx.stroke()}
}

function gDrawPath(){
  if(PATH.length<2)return;
  gctx.save();gctx.lineCap='round';gctx.lineJoin='round';
  gctx.strokeStyle='#1a2030';gctx.lineWidth=44;gctx.beginPath();gctx.moveTo(PATH[0].x,PATH[0].y);PATH.forEach((p,i)=>{if(i>0)gctx.lineTo(p.x,p.y)});gctx.stroke();
  gctx.strokeStyle='#1e2838';gctx.lineWidth=40;gctx.beginPath();gctx.moveTo(PATH[0].x,PATH[0].y);PATH.forEach((p,i)=>{if(i>0)gctx.lineTo(p.x,p.y)});gctx.stroke();
  gctx.strokeStyle='rgba(255,255,255,.04)';gctx.lineWidth=2;gctx.setLineDash([10,14]);gctx.beginPath();gctx.moveTo(PATH[0].x,PATH[0].y);PATH.forEach((p,i)=>{if(i>0)gctx.lineTo(p.x,p.y)});gctx.stroke();gctx.setLineDash([]);
  gctx.fillStyle='#60f0a0';gctx.beginPath();gctx.arc(PATH[0].x,PATH[0].y,9,0,Math.PI*2);gctx.fill();
  gctx.fillStyle='#f06060';gctx.beginPath();gctx.arc(PATH[PATH.length-1].x,PATH[PATH.length-1].y,9,0,Math.PI*2);gctx.fill();
  gctx.restore();
}

function gDrawRanges(){gTowers.forEach(t=>{if(t!==gSelTower)return;gctx.save();gctx.strokeStyle=t.color+'66';gctx.fillStyle=t.color+'11';gctx.lineWidth=1;gctx.beginPath();gctx.arc(t.x,t.y,t.range,0,Math.PI*2);gctx.fill();gctx.stroke();gctx.restore()})}

function gDrawTowers(){
  gTowers.forEach(t=>{
    const def=TD.towers.find(d=>d.id===t.id),sel=t===gSelTower;
    gctx.save();gctx.shadowColor=t.color;gctx.shadowBlur=sel?18:8;
    gctx.fillStyle=sel?t.color+'44':'#1a2030';gctx.strokeStyle=t.color;gctx.lineWidth=sel?2:1.5;
    gctx.beginPath();gctx.arc(t.x,t.y,17,0,Math.PI*2);gctx.fill();gctx.stroke();
    gctx.shadowBlur=0;gctx.font='14px serif';gctx.textAlign='center';gctx.textBaseline='middle';gctx.fillText(def.icon,t.x,t.y);
    if(t.level>1){gctx.fillStyle=t.color;gctx.font='bold 9px sans-serif';gctx.fillText(t.level,t.x+11,t.y-11)}
    gctx.restore();
  });
}

function gDrawEnemies(){
  gEnemies.forEach(e=>{
    if(e.dead)return;
    gctx.save();
    const sl=e.slowed>0,bu=e.burning>0;
    gctx.shadowColor=bu?'#ff8800':sl?'#60c8f0':e.color;gctx.shadowBlur=7;
    gctx.fillStyle=sl?'#60c8f0':bu?'#ff8800':e.color;
    gctx.beginPath();gctx.arc(e.x,e.y,e.size,0,Math.PI*2);gctx.fill();
    if(e.armor>0){gctx.strokeStyle='#aabbff';gctx.lineWidth=Math.min(e.armor,3);gctx.beginPath();gctx.arc(e.x,e.y,e.size,0,Math.PI*2);gctx.stroke()}
    const bw=e.size*2.4,bh=3,bx=e.x-bw/2,by=e.y-e.size-7;
    gctx.fillStyle='#333';gctx.fillRect(bx,by,bw,bh);
    const pct=Math.max(0,e.hp/e.maxHp);
    gctx.fillStyle=pct>.5?'#60f0a0':pct>.25?'#f0a060':'#f06060';gctx.fillRect(bx,by,bw*pct,bh);
    gctx.restore();
  });
}

function gDrawBullets(){gBullets.forEach(b=>{gctx.save();gctx.fillStyle=b.color;gctx.shadowColor=b.color;gctx.shadowBlur=7;gctx.beginPath();gctx.arc(b.x,b.y,b.splash?4:2.5,0,Math.PI*2);gctx.fill();gctx.restore()})}
function gDrawParts(){gParts.forEach(p=>{gctx.save();gctx.globalAlpha=p.life/p.maxLife;gctx.fillStyle=p.color;gctx.beginPath();gctx.arc(p.x,p.y,2.5,0,Math.PI*2);gctx.fill();gctx.restore()})}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORDLE+
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORD_LISTS = {"3": ["cat", "dog", "run", "sun", "hat", "big", "red", "eat", "hot", "cup", "fly", "joy", "key", "map", "net", "owl", "pan", "rat", "sea", "tip", "van", "win", "zoo", "arm", "box", "cry", "dip", "egg", "fan", "fog", "gem", "hit", "ice", "jar", "kit", "log", "mud", "nap", "oak", "paw", "pit", "row", "sap", "tax", "urn", "vow", "wax", "yak", "zip", "ace", "age", "ago", "aid", "aim", "air", "all", "arc", "ask", "awe", "axe", "bad", "bag", "ban", "bar", "bat", "bay", "bed", "beg", "bet", "bid", "bit", "bob", "bog", "bow", "bud", "bug", "bun", "bus", "but", "buy", "cab", "can", "cap", "car", "cog", "cop", "cot", "cub", "cut", "dad", "dam", "dew", "dig", "dim", "dip", "dot", "dry", "dug", "dye", "ear", "era", "eve", "ewe", "eye", "fat", "fee", "few", "fib", "fin", "fit", "fix", "fur", "gap", "gas", "get", "god", "got", "gum", "gun", "gut", "guy", "gym", "had", "ham", "has", "hay", "hid", "him", "his", "hoe", "hog", "hop", "hot", "hug", "hum", "hut", "ill", "imp", "ink", "inn", "ire", "irk", "ivy", "jab", "jag", "jam", "jaw", "jet", "jot", "joy", "jug", "jut", "keg", "kid", "kin", "lab", "lag", "lap", "law", "lay", "led", "leg", "let", "lid", "lip", "lit", "lot", "low", "lug", "mad", "man", "mat", "max", "mob", "mop", "mow", "nab", "nag", "nip", "nod", "nun", "nut", "odd", "off", "oil", "old", "opt", "orb", "ore", "our", "out", "owe", "own", "pad", "pal", "peg", "pen", "pet", "pie", "pig", "pin", "pod", "pop", "pot", "pow", "pro", "pub", "pun", "pup", "pus", "put", "rag", "ram", "raw", "ray", "rib", "rid", "rig", "rip", "rob", "rod", "rot", "rub", "rug", "rum", "rut", "sad", "sag", "set", "sew", "shy", "sin", "sip", "sir", "sit", "ski", "sky", "sly", "sob", "sob", "sod", "son", "sop", "sow", "spa", "spy", "sob", "sty", "sue", "sum", "sup", "tab", "tan", "tap", "tar", "tea", "ten", "tie", "tin", "top", "toy", "try", "tub", "tug", "two", "urn", "use", "vim", "vow", "war", "was", "wet", "who", "why", "wig", "wit", "woe", "wok", "won", "woo", "wow", "yam", "yap", "yew", "yet", "you"], "4": ["able", "acid", "aged", "also", "area", "army", "away", "baby", "back", "ball", "band", "bank", "base", "bath", "bear", "beat", "been", "bell", "belt", "best", "bird", "blow", "blue", "boat", "bold", "bolt", "bond", "bone", "book", "boom", "boot", "born", "both", "bowl", "bush", "busy", "call", "calm", "came", "card", "care", "case", "cash", "cast", "cave", "cell", "chat", "chin", "chip", "city", "clap", "clay", "clip", "club", "clue", "coal", "coat", "code", "coil", "coin", "cold", "comb", "come", "cool", "cope", "copy", "cord", "core", "corn", "cost", "crew", "crop", "cube", "cure", "curl", "cute", "dark", "data", "dawn", "days", "dead", "deal", "dean", "dear", "deck", "deed", "deep", "deer", "deft", "deli", "deny", "desk", "dial", "dice", "diet", "dirt", "dish", "disk", "dock", "does", "done", "door", "dose", "down", "draw", "drew", "drip", "drop", "drum", "dual", "dull", "dump", "dune", "dusk", "dust", "duty", "each", "earn", "east", "easy", "echo", "edge", "edit", "else", "emit", "epic", "even", "ever", "evil", "exam", "exit", "face", "fact", "fail", "fair", "fake", "fall", "fame", "fast", "fate", "fawn", "fear", "feat", "feed", "feel", "feet", "fell", "felt", "fern", "file", "fill", "film", "find", "fine", "fire", "firm", "fish", "fist", "five", "flag", "flat", "flaw", "fled", "flex", "flip", "flow", "foam", "fold", "folk", "font", "fool", "foot", "ford", "fore", "fork", "form", "fort", "foul", "four", "free", "from", "fuel", "full", "fund", "fuse", "gale", "game", "gang", "gate", "gave", "gaze", "gear", "gill", "give", "glad", "glow", "glue", "goal", "goes", "gold", "golf", "gone", "good", "grab", "gray", "grew", "grid", "grip", "grow", "gulf", "gust", "half", "hall", "hand", "hang", "hard", "harm", "harp", "hash", "hast", "have", "head", "heal", "heap", "heat", "heel", "help", "herb", "herd", "here", "hero", "hide", "high", "hill", "hint", "hold", "hole", "home", "hook", "hope", "horn", "hose", "host", "hour", "huge", "hull", "hump", "hunt", "hurt", "hymn", "idea", "idle", "inch", "info", "iron", "item", "jade", "jail", "jazz", "jean", "jerk", "jive", "join", "joke", "jolt", "jump", "junk", "jury", "just", "keen", "keep", "kind", "king", "knit", "knob", "know", "lack", "lady", "laid", "lake", "lamp", "land", "lane", "lark", "last", "late", "laud", "lawn", "lead", "leaf", "lean", "leap", "left", "lend", "lens", "lift", "like", "lime", "line", "link", "lion", "list", "live", "load", "loaf", "loan", "lock", "loft", "lone", "long", "look", "loom", "loop", "lord", "lore", "lore", "loss", "lost", "loud", "love", "luck", "lull", "lump", "lung", "lurk", "lush", "made", "main", "make", "male", "mall", "malt", "many", "mark", "mars", "mast", "math", "meal", "mean", "meat", "meet", "melt", "memo", "menu", "mere", "mesh", "mild", "mile", "milk", "mill", "mime", "mind", "mine", "mint", "miss", "mist", "mode", "mole", "monk", "moon", "more", "most", "move", "much", "mule", "muse", "must", "nail", "name", "navy", "near", "neat", "need", "nest", "news", "next", "nice", "nine", "node", "none", "noon", "norm", "nose", "note", "noun", "obey", "odds", "okay", "once", "only", "open", "oval", "oven", "over", "owed", "pace", "pack", "page", "paid", "pair", "pale", "palm", "park", "part", "pass", "past", "path", "pave", "peak", "peel", "peer", "pest", "pick", "pile", "pine", "pink", "pipe", "plan", "play", "plea", "plot", "plow", "plug", "plum", "plus", "poem", "poet", "pole", "poll", "pond", "pool", "poor", "pore", "port", "pose", "post", "pour", "pray", "prey", "prim", "prom", "prop", "pull", "pump", "push", "quit", "quiz", "race", "rack", "rage", "rail", "rain", "rake", "rank", "rare", "rate", "read", "real", "reap", "rear", "rely", "rent", "rest", "rice", "rich", "ride", "rife", "ring", "riot", "rise", "risk", "road", "roam", "roar", "roast", "robe", "rock", "rode", "role", "roll", "roof", "room", "rope", "rose", "rule", "rush", "rust", "safe", "sage", "said", "sail", "salt", "same", "sand", "sane", "sang", "sash", "save", "seed", "seek", "seem", "seen", "self", "sell", "send", "shed", "ship", "shop", "shot", "show", "shrub", "shut", "sick", "side", "sigh", "silk", "sing", "sink", "site", "size", "skew", "skin", "skip", "slam", "slap", "sled", "slim", "slip", "slow", "slug", "slum", "snap", "snow", "soak", "soar", "sock", "soft", "soil", "sole", "some", "song", "soon", "sore", "soul", "soup", "sour", "spin", "spit", "spot", "stay", "stem", "step", "stir", "stop", "stub", "such", "suit", "sulk", "sure", "swim", "tail", "tale", "tall", "tank", "task", "tell", "tent", "term", "test", "than", "that", "them", "then", "they", "thin", "this", "tick", "tile", "till", "time", "tiny", "tire", "toad", "toil", "told", "toll", "tomb", "tone", "tool", "tore", "torn", "tour", "town", "trap", "tray", "tree", "trim", "trio", "trip", "true", "tuck", "tune", "turn", "tusk", "twin", "type", "ugly", "undo", "unit", "upon", "used", "user", "vain", "vale", "vast", "veil", "vein", "very", "vice", "view", "vine", "void", "vote", "wade", "wage", "wake", "walk", "wall", "want", "ward", "warm", "warn", "warp", "wash", "wave", "weak", "weed", "week", "well", "went", "were", "west", "what", "when", "whom", "wide", "wife", "wild", "will", "wind", "wine", "wing", "wire", "wise", "wish", "with", "wolf", "womb", "wood", "word", "wore", "work", "worm", "worn", "wrap", "wren", "writ", "yawn", "year", "yell", "your", "zero", "zone", "zoom"], "5": ["about", "above", "abuse", "actor", "acute", "adult", "after", "again", "agent", "agree", "ahead", "alarm", "album", "alert", "alike", "align", "alive", "alley", "allow", "alone", "along", "aloof", "aloud", "alter", "angel", "anger", "angle", "angry", "anime", "annex", "antic", "anvil", "apart", "apple", "apply", "aptly", "argue", "arise", "armor", "aroma", "array", "arrow", "aside", "atlas", "attic", "audio", "audit", "avoid", "awake", "award", "aware", "awful", "basic", "basis", "beach", "beard", "beast", "began", "begin", "being", "below", "bench", "berry", "birth", "bison", "biter", "black", "blade", "blame", "bland", "blank", "blast", "blaze", "bleak", "blend", "bless", "bliss", "block", "blood", "bloom", "blown", "board", "boast", "bonus", "booth", "botch", "bound", "boxed", "brace", "braid", "brain", "brand", "brave", "bread", "break", "breed", "brick", "bride", "brief", "bring", "brisk", "broke", "brood", "brook", "broom", "brown", "brush", "brute", "buddy", "build", "built", "bunch", "burst", "buyer", "candy", "cargo", "carry", "catch", "cause", "chalk", "chaos", "charm", "chart", "chase", "cheap", "cheat", "check", "cheek", "cheer", "chess", "chest", "chief", "child", "china", "choir", "chord", "claim", "clamp", "clang", "clash", "clasp", "class", "clean", "clear", "clerk", "click", "cliff", "climb", "cling", "clock", "clone", "close", "cloth", "cloud", "clown", "coach", "coast", "comet", "comic", "comma", "couch", "count", "court", "cover", "crack", "craft", "crane", "crash", "creak", "cream", "creed", "crime", "crisp", "cross", "crowd", "crown", "crude", "crush", "crush", "crux", "curve", "cycle", "daily", "dance", "decay", "decoy", "decry", "delay", "delta", "demon", "dense", "depot", "depot", "depth", "derby", "devil", "dirty", "disco", "ditch", "dizzy", "dodge", "doing", "donor", "doubt", "dough", "draft", "drain", "drama", "drape", "dread", "dream", "drill", "drink", "drive", "drone", "drool", "drove", "dryer", "dunce", "dwarf", "dwell", "dying", "eager", "early", "earth", "eight", "elite", "empty", "enemy", "enjoy", "enter", "entry", "equal", "error", "essay", "evade", "event", "every", "exact", "excel", "exert", "exile", "exist", "expel", "extra", "fable", "faint", "faith", "fancy", "fatal", "favor", "feast", "fence", "fever", "fewer", "fiber", "field", "fiend", "fifth", "fifty", "fight", "final", "finch", "fixed", "flair", "flame", "flank", "flare", "flash", "flask", "fleet", "flesh", "flick", "flock", "flood", "floor", "floss", "flute", "foamy", "focus", "force", "forge", "forte", "forum", "found", "frame", "frank", "fraud", "fresh", "front", "frost", "frown", "froze", "fruit", "fully", "funny", "fuzzy", "gaunt", "gavel", "giant", "given", "gland", "glare", "glass", "glaze", "gleam", "glide", "gloom", "glory", "glove", "going", "gorge", "gouge", "gourd", "grace", "grade", "grain", "grand", "grant", "grasp", "grass", "grate", "grave", "graze", "greed", "green", "greet", "grief", "grind", "groan", "groin", "groom", "grope", "group", "grove", "grown", "gruel", "gruff", "guard", "guess", "guest", "guide", "guild", "guile", "guise", "gusto", "hasty", "hatch", "haunt", "havoc", "heart", "heavy", "hence", "hinge", "hippo", "hoard", "holly", "honey", "honor", "hotel", "house", "human", "humid", "hurry", "hyena", "image", "imply", "inbox", "infer", "inner", "input", "inter", "issue", "ivory", "judge", "juice", "juicy", "jumbo", "karma", "kayak", "knack", "kneel", "knife", "knock", "knoll", "known", "label", "large", "laser", "later", "laugh", "layer", "learn", "ledge", "legal", "lemon", "level", "light", "lilac", "limit", "lined", "liner", "liver", "llama", "lodge", "lofty", "logic", "loose", "lover", "lower", "lucky", "lunar", "lunch", "lusty", "lyric", "magic", "major", "maker", "manor", "maple", "match", "maybe", "mayor", "media", "might", "mimic", "minor", "minus", "mirth", "moist", "money", "month", "moral", "mouse", "mouth", "movie", "muddy", "music", "naive", "nasty", "naval", "never", "night", "noble", "noise", "novel", "nymph", "ocean", "offer", "often", "olive", "onset", "orbit", "order", "other", "ought", "outer", "ounce", "outdo", "owner", "ozone", "paint", "panic", "paper", "patch", "pause", "peace", "peach", "pearl", "pedal", "penny", "perch", "peril", "perky", "petal", "phase", "phone", "photo", "piano", "piece", "pilot", "pinch", "pitch", "pixel", "pixel", "pizza", "place", "plaid", "plain", "plane", "plank", "plant", "plate", "plaza", "pleat", "pluck", "plume", "plump", "plunge", "plunk", "plush", "poach", "point", "polar", "poppy", "pound", "power", "prank", "press", "price", "prick", "pride", "prime", "print", "prior", "prism", "prize", "probe", "prone", "proof", "prose", "proud", "prove", "prowl", "prune", "psalm", "psych", "pulse", "punch", "pupil", "puppy", "purse", "query", "queen", "quest", "queue", "quick", "quiet", "quirk", "quota", "quote", "rabbi", "rainy", "rally", "range", "rapid", "raven", "reach", "rebel", "regal", "relay", "repay", "repel", "repro", "rerun", "rider", "right", "rigor", "risen", "risky", "rivet", "rival", "river", "robin", "robot", "rocky", "rouge", "rough", "round", "route", "rowdy", "royal", "rugby", "ruler", "rural", "rusty", "sadly", "saint", "salsa", "sandy", "sauce", "scald", "scalp", "scamp", "scant", "scare", "scene", "scoop", "score", "scout", "scowl", "scram", "scrap", "scrub", "seize", "sense", "seven", "shade", "shaft", "shake", "shall", "shame", "shape", "share", "shark", "sharp", "shave", "shawl", "sheen", "sheep", "sheer", "shelf", "shell", "shift", "shine", "shire", "shirt", "shock", "shore", "short", "shout", "shove", "showy", "shred", "shrub", "shrug", "sight", "silly", "since", "sixth", "sixty", "skate", "skill", "skimp", "skulk", "skull", "skunk", "slack", "slate", "sleet", "slept", "slide", "slope", "sloth", "slump", "slunk", "slurp", "smack", "small", "smart", "smash", "smear", "smell", "smile", "smirk", "smite", "smoke", "snack", "snail", "snake", "snare", "sneak", "sneer", "sniff", "snort", "snout", "snuck", "solar", "solid", "solve", "sorry", "south", "space", "spade", "spare", "spark", "spear", "speck", "speed", "spell", "spend", "spicy", "spike", "spine", "spire", "spite", "split", "spoil", "spoke", "spoof", "spook", "spool", "spoon", "spout", "spray", "spree", "sprig", "sprint", "spunk", "squad", "squat", "squid", "stack", "staff", "stage", "stain", "stair", "stake", "stale", "stall", "stamp", "stand", "stare", "stark", "start", "state", "stave", "stead", "steak", "steal", "steam", "steel", "steep", "steer", "stern", "stick", "stiff", "still", "sting", "stock", "stomp", "stone", "stool", "storm", "story", "stout", "stove", "strap", "straw", "stray", "strip", "strut", "study", "stump", "stung", "stunk", "stunt", "style", "sugar", "suite", "sunny", "super", "surge", "swamp", "swarm", "swear", "sweat", "sweep", "sweet", "swept", "swill", "swipe", "swirl", "swoop", "sword", "swore", "swung", "table", "taunt", "tense", "theft", "their", "theme", "there", "these", "thick", "thing", "think", "third", "thorn", "those", "three", "threw", "throw", "thrum", "thumb", "thump", "thyme", "tidal", "tiger", "tight", "timer", "tired", "title", "today", "token", "tonic", "touch", "tough", "tower", "toxic", "trace", "track", "trade", "trail", "train", "trait", "trash", "trawl", "trend", "trial", "trick", "tried", "tripe", "trite", "troll", "troop", "troth", "trout", "truck", "truly", "trunk", "truss", "trust", "truth", "tuber", "tulip", "tuner", "tunic", "turbo", "tutor", "twang", "tweed", "twice", "twist", "tying", "ultra", "uncut", "under", "unfit", "unify", "union", "unity", "until", "upper", "upset", "urban", "utile", "utter", "vague", "valid", "value", "vapor", "vault", "vaunt", "veiny", "verse", "vigor", "viola", "viper", "visit", "visor", "vista", "vital", "vivid", "vixen", "vocal", "vodka", "voila", "voter", "vouch", "vowel", "vying", "wacky", "waltz", "waste", "watch", "water", "weary", "weave", "wedge", "weedy", "weird", "whale", "whack", "wheat", "wheel", "where", "which", "while", "whiff", "whirl", "white", "whole", "whose", "widen", "wider", "wield", "wimpy", "windy", "witty", "women", "woods", "wordy", "world", "worry", "worse", "worst", "worth", "would", "wound", "wrath", "wreak", "wreck", "wring", "wrist", "write", "wrong", "wrote", "yacht", "yield", "young", "youth", "zebra", "zesty"], "6": ["ablaze", "abroad", "accept", "access", "accord", "accuse", "aching", "action", "active", "actual", "adhere", "adjust", "admire", "animal", "answer", "antler", "arcade", "arctic", "around", "artist", "assume", "assure", "attach", "attack", "attend", "attire", "autumn", "avenue", "awaken", "barrel", "battle", "beauty", "beckon", "before", "behave", "belief", "belong", "beside", "bicker", "bitter", "blazed", "blight", "bottle", "bottom", "bought", "bounty", "boxing", "breach", "breath", "bridge", "bright", "buster", "butter", "button", "cactus", "camera", "candle", "canvas", "carpet", "castle", "casual", "caught", "cauldron", "cement", "center", "change", "charge", "cheese", "choose", "chorus", "circle", "circus", "clouds", "clutch", "cobalt", "combat", "comedy", "commit", "common", "compass", "corner", "cotton", "cougar", "couple", "course", "create", "crisis", "crunchy", "crying", "cuddle", "custom", "dagger", "dancer", "danger", "darken", "deadly", "debate", "decent", "decide", "defend", "degree", "delight", "demand", "design", "desire", "detail", "devour", "direct", "doctor", "dollar", "domain", "donkey", "dragon", "easily", "eaten", "effect", "effort", "elicit", "empire", "enable", "endure", "energy", "engage", "engine", "enjoin", "enough", "entire", "escape", "evolve", "excite", "excuse", "exotic", "expand", "expect", "expert", "export", "facade", "failed", "fallow", "family", "famine", "father", "feline", "fellow", "female", "fender", "fickle", "fierce", "finger", "fisher", "fishy", "flaunt", "flavor", "flight", "follow", "forest", "formal", "formed", "foster", "frozen", "future", "garden", "gather", "gentle", "glance", "global", "goblin", "goblet", "gothic", "govern", "gravel", "greedy", "growth", "grudge", "guitar", "happen", "harbor", "hardly", "hazard", "health", "hearth", "heaven", "helmet", "heroes", "hiding", "history", "holler", "honest", "hunter", "ignore", "illume", "insect", "inside", "insist", "intend", "invent", "island", "jangle", "jester", "jostle", "jungle", "knight", "launch", "latter", "locket", "mantle", "marble", "market", "mortal", "mother", "muster", "myself", "mystic", "narrow", "nature", "nectar", "negate", "nestle", "nimble", "notice", "nourish", "object", "obtain", "offend", "omelet", "oppose", "origin", "output", "oyster", "palace", "parent", "parrot", "patrol", "pebble", "pencil", "pirate", "planet", "plunge", "pocket", "poison", "potent", "powder", "prefer", "pretty", "prince", "prison", "prompt", "proper", "proves", "public", "purple", "python", "rabbit", "racket", "radish", "random", "rascal", "rather", "reason", "recipe", "record", "reduce", "refine", "region", "remain", "renown", "repair", "repeat", "rescue", "result", "return", "reveal", "riddle", "ripple", "robust", "rocket", "rotten", "rotate", "rumble", "rustle", "sailor", "sample", "saturn", "savage", "scarce", "screen", "search", "secret", "settle", "shadow", "simple", "single", "sister", "sketch", "sleuth", "sliver", "smooth", "snatch", "socket", "spider", "spirit", "splash", "spoken", "spring", "sprout", "squash", "stable", "statue", "stereo", "stream", "street", "strict", "strong", "struck", "studio", "submit", "subtle", "sudden", "summer", "sunset", "switch", "symbol", "target", "temple", "tender", "theory", "thread", "throat", "throne", "throve", "ticket", "timber", "toggle", "torque", "toucan", "toward", "travel", "treats", "tribal", "truant", "turret", "turtle", "unless", "update", "uproot", "useful", "velvet", "vendor", "vertex", "vessel", "victim", "violet", "vision", "wanted", "wealth", "weapon", "weasel", "weekly", "weight", "winter", "wonder", "wooden", "worthy", "wrestle", "zipper"], "7": ["ability", "absence", "account", "achieve", "acquire", "address", "advance", "against", "ailment", "airship", "alcohol", "antique", "anxious", "ancient", "believe", "beneath", "benefit", "blocked", "blossom", "blunder", "cabinet", "captain", "capture", "careful", "ceiling", "century", "certain", "chapter", "chicken", "chimney", "claimed", "classic", "climate", "comfort", "command", "compete", "complex", "concept", "concern", "conduct", "confirm", "connect", "contain", "control", "correct", "cottage", "council", "country", "crumble", "cushion", "customs", "declare", "default", "defence", "deliver", "descent", "display", "distant", "disturb", "divided", "dolphin", "drawing", "earthen", "eastern", "ecology", "element", "elevate", "emotion", "emperor", "endorse", "enforce", "enhance", "enlarge", "enquiry", "episode", "erosion", "essence", "ethical", "example", "explain", "express", "extreme", "failure", "fantasy", "fashion", "feature", "fiction", "finance", "forward", "freedom", "freight", "frosted", "further", "gallery", "general", "genesis", "gladden", "glorify", "glowing", "grandma", "gratify", "harmony", "harvest", "healthy", "helpful", "history", "horizon", "hunting", "include", "inhabit", "inherit", "initial", "install", "instead", "intense", "involve", "joining", "justice", "kitchen", "lantern", "leather", "lighten", "logical", "loyalty", "machine", "married", "meaning", "measure", "medical", "mixture", "morning", "musical", "mystery", "nothing", "noticed", "nourish", "obscure", "opinion", "outrage", "outside", "oxidize", "package", "partner", "passive", "pattern", "perform", "physics", "picture", "pilgrim", "prevent", "primary", "problem", "process", "program", "project", "promise", "protect", "provide", "publish", "purpose", "quality", "quarter", "quietly", "radiant", "reality", "receive", "recover", "reflect", "release", "relieve", "replace", "request", "require", "restore", "retired", "resolve", "revenge", "revival", "rolling", "routing", "running", "satisfy", "science", "section", "service", "seventh", "several", "silence", "similar", "society", "somehow", "someone", "special", "station", "storage", "strange", "stretch", "student", "subject", "success", "summary", "support", "surface", "teacher", "tension", "through", "tragedy", "triumph", "trouble", "twisted", "typical", "undergo", "uniform", "unsound", "upgrade", "upwards", "venture", "various", "vibrant", "victory", "village", "washing", "website", "western", "whether", "willing", "winning", "wishing", "witness", "written", "younger"], "8": ["absolute", "abstract", "accurate", "achieved", "acquired", "addicted", "adequate", "adjusted", "advanced", "affirmed", "aircraft", "allotted", "although", "analysis", "annually", "approach", "argument", "armchair", "aspirate", "assemble", "attached", "availing", "balanced", "behavior", "believed", "backbone", "branches", "breathe", "building", "calendar", "captured", "category", "champion", "changing", "children", "circular", "climbing", "combined", "commerce", "complain", "complete", "compound", "computer", "confined", "conflict", "confused", "consider", "constant", "consumed", "continue", "contrast", "convince", "corridor", "coverage", "creating", "cultural", "daughter", "decision", "declared", "declined", "defended", "delicate", "detailed", "dialogue", "directly", "disaster", "discover", "disfavor", "distance", "distinct", "divorced", "dominant", "dramatic", "duration", "educated", "emerging", "emotional", "employed", "enclosed", "endanger", "enormous", "enrolled", "entering", "equation", "eruption", "eventual", "everyone", "evidence", "evolving", "exercise", "existing", "external", "familiar", "feminine", "festival", "finished", "flapping", "flexible", "followed", "football", "forceful", "freckled", "friendly", "fraction", "frontier", "function", "generate", "generous", "glorious", "graceful", "grateful", "greatest", "guardian", "handling", "happiest", "included", "indicate", "industry", "informal", "injuries", "insights", "inspired", "intended", "interior", "involved", "isolated", "jealousy", "junction", "language", "launched", "learning", "likewise", "limiting", "listener", "literary", "location", "lonesome", "magnetic", "married", "maximize", "material", "maximize", "measured", "medicine", "midnight", "military", "minimize", "misguide", "moderate", "momentum", "moreover", "mountain", "navigate", "negative", "normally", "northern", "notably", "obstacle", "occurred", "official", "organize", "original", "overcome", "overlook", "painting", "particle", "patience", "peaceful", "peculiar", "perceive", "personal", "platform", "pleasant", "positive", "possible", "powerful", "practice", "precious", "prepared", "presence", "previous", "probable", "problems", "promised", "properly", "proposal", "proposed", "province", "publicly", "readable", "realized", "recently", "received", "referred", "regional", "rejected", "relative", "relevant", "reliable", "remained", "remember", "replaced", "reported", "required", "resident", "resolved", "resource", "resulted", "returned", "revealed", "romantic", "schedule", "selected", "sentence", "sequence", "shortage", "shoulder", "singular", "skeleton", "slightly", "smallest", "speaking", "specific", "standard", "starting", "strength", "stubborn", "suddenly", "superior", "supposed", "survived", "swimming", "talented", "taxation", "teaching", "thinking", "together", "tomorrow", "touching", "training", "traveled", "tropical", "troubled", "truthful", "ultimate", "umbrella", "universe", "unlocked", "upcoming", "valuable", "variable", "violence", "volcanic", "wandered", "waterfowl", "whatever", "wherever", "wildlife", "withdraw", "wondered", "yourself"]};

const WSK = 'wordle_v1';
function wLoadStats(){
  try{return JSON.parse(localStorage.getItem(WSK))||{}}catch{return{}}
}
function wSaveStats(){localStorage.setItem(WSK,JSON.stringify(wAllStats))}

let wAllStats = wLoadStats(); // keyed by letter count e.g. "5"
let wLen = 5;
let wAnswer = '';
let wGuesses = []; // array of submitted guess strings
let wCurrent = ''; // current in-progress guess
let wGameOver = false;

function wGetStats(len){
  const k = String(len);
  if(!wAllStats[k]) wAllStats[k] = {played:0,wins:0,streak:0,best:0,dist:{}};
  return wAllStats[k];
}

function wInit(){
  // Defer so the screen is visible and has real dimensions before we measure
  setTimeout(()=>{
    wRenderBoard();
    wRenderKeyboard();
    wUpdateStatsBar();
  }, 30);
}

function wSetLen(n){
  wLen = n;
  document.querySelectorAll('.wlen-btn').forEach((b,i)=>b.classList.toggle('active',[3,4,5,6,7,8][i]===n));
  // Load last game state for this length if any
  const saved = wAllStats['game_'+n];
  if(saved && !saved.over){
    wAnswer = saved.answer;
    wGuesses = saved.guesses||[];
    wCurrent = '';
    wGameOver = false;
  } else {
    wNewGame();
    return;
  }
  document.getElementById('w-msg').textContent = '';
  document.getElementById('w-new-btn').style.display = wGameOver ? 'block' : 'none';
  wRenderBoard();
  wRenderKeyboard();
  wUpdateStatsBar();
}

function wNewGame(){
  const list = WORD_LISTS[wLen];
  wAnswer = list[Math.floor(Math.random()*list.length)].toUpperCase();
  wGuesses = [];
  wCurrent = '';
  wGameOver = false;
  document.getElementById('w-msg').textContent = '';
  document.getElementById('w-new-btn').style.display = 'none';
  wSaveGameState();
  // Small defer so layout is ready if called right on screen switch
  setTimeout(()=>{
    wRenderBoard();
    wRenderKeyboard();
    wUpdateStatsBar();
  }, 20);
}

function wSaveGameState(){
  const k = 'game_'+wLen;
  if(!wAllStats[k]) wAllStats[k] = {};
  wAllStats[k].answer = wAnswer;
  wAllStats[k].guesses = wGuesses;
  wAllStats[k].over = wGameOver;
  wSaveStats();
}

function wEval(guess){
  // Returns array of {letter, status} â€” correct/present/absent
  const ans = wAnswer.split('');
  const result = Array(wLen).fill(null).map((_,i)=>({letter:guess[i],status:'absent'}));
  const ansLeft = [...ans];
  // First pass: correct
  result.forEach((r,i)=>{if(r.letter===ans[i]){r.status='correct';ansLeft[i]=null}});
  // Second pass: present
  result.forEach((r,i)=>{
    if(r.status!=='correct'){
      const j=ansLeft.indexOf(r.letter);
      if(j!==-1){r.status='present';ansLeft[j]=null}
    }
  });
  return result;
}

function wRenderBoard(){
  const board = document.getElementById('w-board');
  board.innerHTML = '';

  const ROWS = 5;
  const totalRows = wGuesses.length + (wGameOver ? 0 : 1);
  const visStart = Math.max(0, totalRows - ROWS);

  for(let r = 0; r < ROWS; r++){
    const absRow = visStart + r;
    const row = document.createElement('div');
    row.className = 'w-row';

    // Row number
    const num = document.createElement('div');
    num.className = 'w-row-num' + (absRow === wGuesses.length && !wGameOver ? ' active-num' : '');
    num.textContent = absRow + 1;
    row.appendChild(num);

    // Tiles
    const tiles = document.createElement('div');
    tiles.className = 'w-tiles';

    if(absRow < wGuesses.length){
      wEval(wGuesses[absRow]).forEach(({letter, status}) => {
        const t = document.createElement('div');
        t.className = 'w-tile ' + status;
        t.textContent = letter;
        tiles.appendChild(t);
      });
    } else if(absRow === wGuesses.length && !wGameOver){
      for(let i = 0; i < wLen; i++){
        const t = document.createElement('div');
        t.className = 'w-tile' + (i < wCurrent.length ? ' filled' : '');
        t.textContent = i < wCurrent.length ? wCurrent[i] : '';
        tiles.appendChild(t);
      }
    } else {
      for(let i = 0; i < wLen; i++){
        const t = document.createElement('div');
        t.className = 'w-tile';
        tiles.appendChild(t);
      }
    }
    row.appendChild(tiles);
    board.appendChild(row);
  }
}

function wRenderKeyboard(){
  const rows = [
    ['Q','W','E','R','T','Y','U','I','O','P'],
    ['A','S','D','F','G','H','J','K','L'],
    ['ENTER','Z','X','C','V','B','N','M','âŒ«']
  ];
  const kbd = document.getElementById('w-keyboard');
  kbd.innerHTML = '';

  const state = {};
  wGuesses.forEach(guess=>{
    wEval(guess).forEach(({letter,status})=>{
      const prev = state[letter];
      if(prev==='correct') return;
      if(status==='correct'||!prev||(status==='present'&&prev==='absent')) state[letter]=status;
    });
  });

  rows.forEach(row=>{
    const rowEl = document.createElement('div');
    rowEl.className = 'w-kbd-row';
    row.forEach(key=>{
      const btn = document.createElement('button');
      btn.className = 'w-key' + (key==='ENTER' ? ' wide-enter' : key==='âŒ«' ? ' wide-del' : '');
      const st = state[key];
      if(st) btn.classList.add(st);
      btn.textContent = key;
      btn.onclick = ()=>wKey(key);
      rowEl.appendChild(btn);
    });
    kbd.appendChild(rowEl);
  });
}

function wKey(key){
  if(wGameOver) return;
  if(key==='âŒ«'||key==='BACKSPACE'){
    wCurrent = wCurrent.slice(0,-1);
    wRenderBoard();
    return;
  }
  if(key==='ENTER'){
    wSubmit();
    return;
  }
  if(wCurrent.length<wLen && /^[A-Z]$/.test(key)){
    wCurrent += key;
    wRenderBoard();
    const ROWS=5, totalRows=wGuesses.length+1, visStart=Math.max(0,totalRows-ROWS);
    const visIdx=wGuesses.length-visStart;
    const rows=document.querySelectorAll('#w-board .w-row');
    const curRow=rows[visIdx];
    if(curRow){const t=curRow.querySelectorAll('.w-tile')[wCurrent.length-1];if(t){t.classList.remove('pop');void t.offsetWidth;t.classList.add('pop')}}
  }
}

function wSubmit(){
  if(wCurrent.length<wLen){
    wShakeRow();
    wMsg('Not enough letters');
    return;
  }
  // Check if word is valid (in list)
  const list = WORD_LISTS[wLen];
  if(!list.includes(wCurrent.toLowerCase())){
    wShakeRow();
    wMsg('Not in word list');
    return;
  }
  wGuesses.push(wCurrent);
  const won = wCurrent === wAnswer;
  wCurrent = '';
  wRenderBoard();
  wRenderKeyboard();

  if(won){
    wGameOver = true;
    const numGuesses = wGuesses.length;
    // Update stats
    const s = wGetStats(wLen);
    s.played++;s.wins++;s.streak++;
    if(!s.best || numGuesses < s.best) s.best = numGuesses;
    if(!s.dist[numGuesses]) s.dist[numGuesses]=0;
    s.dist[numGuesses]++;
    wSaveStats();wSaveGameState();
    wUpdateStatsBar();
    // Bounce the winning row tiles
    setTimeout(()=>{
      const ROWS=5, visStart=Math.max(0,wGuesses.length-ROWS);
      const visIdx=(wGuesses.length-1)-visStart;
      const rows=document.querySelectorAll('#w-board .w-row');
      const winRow=rows[visIdx];
      if(winRow) winRow.querySelectorAll('.w-tile').forEach((t,i)=>setTimeout(()=>{t.classList.remove('bounce');void t.offsetWidth;t.classList.add('bounce')},i*80));
    },50);
    setTimeout(()=>{wMsg('ğŸ‰ Got it in '+numGuesses+'!');document.getElementById('w-new-btn').style.display='block'},400);
  } else {
    wSaveGameState();
    document.getElementById('w-msg').textContent='';
  }
}

function wShakeRow(){
  const ROWS=5, totalRows=wGuesses.length+1, visStart=Math.max(0,totalRows-ROWS);
  const visIdx = wGuesses.length - visStart;
  const rows = document.querySelectorAll('#w-board .w-row');
  const cur = rows[visIdx];
  if(!cur) return;
  cur.querySelectorAll('.w-tile').forEach(t=>{t.classList.remove('shake');void t.offsetWidth;t.classList.add('shake')});
}

function wMsg(txt,dur=2500){
  const el=document.getElementById('w-msg');
  el.textContent=txt;
  if(dur) setTimeout(()=>{if(el.textContent===txt)el.textContent=''},dur);
}

function wUpdateStatsBar(){ /* stats bar removed â€” use ğŸ“Š modal */ }

function wShowStats(){
  const s = wGetStats(wLen);
  document.getElementById('wm-len').textContent = wLen;
  document.getElementById('wm-played').textContent = s.played;
  document.getElementById('wm-wins').textContent = s.wins;
  document.getElementById('wm-streak').textContent = s.streak;
  document.getElementById('wm-best').textContent = s.best||0;
  // Distribution
  const dist = document.getElementById('wm-dist');
  dist.innerHTML='';
  const maxVal = Math.max(1,...Object.values(s.dist));
  for(let i=1;i<=20;i++){
    const v = s.dist[i]||0;
    if(v===0 && i>10) continue;
    if(v===0 && !Object.keys(s.dist).some(k=>Number(k)>=i)) continue;
    const row = document.createElement('div');
    row.className='w-dist-row';
    row.innerHTML=`<span class="dlabel">${i}</span><div class="w-dist-bar-wrap"><div class="w-dist-bar" style="width:${Math.max(8,Math.round(v/maxVal*100))}%">${v||''}</div></div>`;
    dist.appendChild(row);
  }
  if(!Object.keys(s.dist).length) dist.innerHTML='<div style="color:var(--muted);font-size:11px">No completed games yet.</div>';
  document.getElementById('w-stats-modal').classList.add('active');
}

// Physical keyboard support
document.addEventListener('keydown',e=>{
  if(!document.getElementById('s-wordle').classList.contains('active')) return;
  if(e.key==='Enter') wKey('ENTER');
  else if(e.key==='Backspace') wKey('âŒ«');
  else if(/^[a-zA-Z]$/.test(e.key)) wKey(e.key.toUpperCase());
});

// Start with 5 letters on first load of wordle
setTimeout(()=>{
  if(!wAnswer){ wLen=5; wNewGame(); }
}, 300);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CRM_SK = 'crm_v1';
function crmLoad(){try{return JSON.parse(localStorage.getItem(CRM_SK))||{contacts:[],logs:[]}}catch{return{contacts:[],logs:[]}}}
function crmSave(){localStorage.setItem(CRM_SK,JSON.stringify(crmData))}
let crmData = crmLoad();
let crmFilter = 'all';
let crmActiveDetail = null;

const CRM_COLORS = ['#4a6fa5','#5a8a5a','#8a5a5a','#7a5a8a','#8a7a5a','#5a8a8a','#8a5a6a','#6a7a5a'];
function crmColor(name){ let h=0;for(let c of name)h=(h*31+c.charCodeAt(0))&0xffff;return CRM_COLORS[h%CRM_COLORS.length] }
function crmInitials(name){ return name.trim().split(/\s+/).map(w=>w[0]).join('').slice(0,2).toUpperCase() }

function crmRender(){
  crmRenderList();
  crmRenderQueue();
  crmRenderTimeline();
}

function crmTab(tab){
  document.querySelectorAll('.crm-tab').forEach((t,i)=>t.classList.toggle('active',['contacts','queue','timeline'][i]===tab));
  document.querySelectorAll('.crm-view').forEach(v=>v.classList.remove('active'));
  document.getElementById('crm-'+tab+'-view').classList.add('active');
}

function crmSetFilter(el, f){
  crmFilter = f;
  document.querySelectorAll('.crm-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  crmRenderList();
}

function crmRenderList(){
  const q = (document.getElementById('crm-search')||{value:''}).value.toLowerCase();
  const list = document.getElementById('crm-list');
  if(!list) return;
  let contacts = [...crmData.contacts];
  if(crmFilter !== 'all') contacts = contacts.filter(c=>c.type===crmFilter);
  if(q) contacts = contacts.filter(c=>(c.name+c.company+c.email+c.phone+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  contacts.sort((a,b)=>a.name.localeCompare(b.name));

  if(!contacts.length){
    list.innerHTML = '<div style="text-align:center;padding:40px 16px;color:var(--muted);font-size:12px">'+(crmData.contacts.length?'No matches':'No contacts yet.<br>Tap + to add one.')+'</div>';
    return;
  }

  list.innerHTML = contacts.map(c=>{
    const lastLog = crmData.logs.filter(l=>l.contactId===c.id).sort((a,b)=>b.date.localeCompare(a.date))[0];
    const lastStr = lastLog ? 'Last: '+fmtDate(lastLog.date) : 'No interactions yet';
    const badge = {friend:'crm-badge-friend',pro:'crm-badge-pro',client:'crm-badge-client'}[c.type]||'';
    const badgeLabel = {friend:'Friend',pro:'Pro',client:'Client'}[c.type]||c.type;
    const due = c.followup ? followupStatus(c.followup.date) : null;
    const dotCls = due ? (due==='overdue'?'crm-follow-dot':due==='today'?'crm-follow-dot soon':'crm-follow-dot ok') : '';
    return `<div class="crm-card" onclick="crmOpenDetail('${c.id}')">
      <div class="crm-avatar" style="background:\${crmColor(c.name)}">\${crmInitials(c.name)}</div>
      <div class="crm-card-info">
        <div class="crm-card-name">\${escH(c.name)}</div>
        <div class="crm-card-sub">\${escH(c.company||lastStr)}</div>
        \${c.company?'<div class="crm-card-sub" style="margin-top:1px">'+escH(lastStr)+'</div>':''}
      </div>
      <div class="crm-card-right">
        <span class="crm-badge \${badge}">\${badgeLabel}</span>
        \${dotCls?'<div class="'+dotCls+'"></div>':''}
      </div>
    </div>`;
  }).join('');
}

function fmtDate(iso){
  const d=new Date(iso+'T12:00:00');
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

function followupStatus(dateStr){
  const today=new Date(); today.setHours(0,0,0,0);
  const d=new Date(dateStr+'T12:00:00'); d.setHours(0,0,0,0);
  if(d<today) return 'overdue';
  if(d.getTime()===today.getTime()) return 'today';
  return 'upcoming';
}

function crmRenderQueue(){
  const ql = document.getElementById('crm-queue-list');
  if(!ql) return;
  const contacts = crmData.contacts.filter(c=>c.followup && c.followup.date);
  contacts.sort((a,b)=>a.followup.date.localeCompare(b.followup.date));

  if(!contacts.length){
    ql.innerHTML='<div style="text-align:center;padding:40px 16px;color:var(--muted);font-size:12px">No follow-ups scheduled.<br>Open a contact to set one.</div>';
    return;
  }

  ql.innerHTML = contacts.map(c=>{
    const st = followupStatus(c.followup.date);
    const tagCls = st==='overdue'?'crm-due-over':st==='today'?'crm-due-today':'crm-due-soon';
    const tagLabel = st==='overdue'?'Overdue':st==='today'?'Today':fmtDate(c.followup.date);
    return `<div class="crm-queue-card">
      <div class="crm-queue-top">
        <div class="crm-avatar" style="background:\${crmColor(c.name)};width:32px;height:32px;font-size:12px">\${crmInitials(c.name)}</div>
        <div class="crm-queue-name" onclick="crmOpenDetail('\${c.id}')">\${escH(c.name)}</div>
        <span class="crm-due-tag \${tagCls}">\${tagLabel}</span>
      </div>
      \${c.followup.action?'<div class="crm-queue-action">'+escH(c.followup.action)+'</div>':''}
      <button class="crm-queue-done" onclick="crmMarkDone('\${c.id}')">âœ“ Mark done â€” log interaction</button>
    </div>`;
  }).join('');
}

function crmMarkDone(id){
  crmActiveDetail = id;
  document.getElementById('crm-log-modal').classList.add('active');
  document.getElementById('crm-l-note').value = '';
  // Will clear followup on save
  const modal = document.getElementById('crm-log-modal');
  modal.dataset.clearFollowup = id;
}

function crmRenderTimeline(){
  const tl = document.getElementById('crm-timeline-list');
  if(!tl) return;
  const logs = [...crmData.logs].sort((a,b)=>b.date.localeCompare(a.date)||b.time.localeCompare(a.time));
  if(!logs.length){
    tl.innerHTML='<div style="text-align:center;padding:40px 16px;color:var(--muted);font-size:12px">No interactions logged yet.</div>';
    return;
  }
  const typeLabel={'call':'ğŸ“ Call','text':'ğŸ’¬ Text','email':'âœ‰ï¸ Email','meet':'ğŸ¤ Met','other':'ğŸ“ Note'};
  let html='', lastDay='';
  logs.forEach(l=>{
    const c = crmData.contacts.find(x=>x.id===l.contactId);
    if(!c) return;
    if(l.date!==lastDay){
      lastDay=l.date;
      html+=`<div class="crm-tl-day">\${fmtDate(l.date)}</div>`;
    }
    html+=`<div class="crm-tl-item">
      <div class="crm-tl-dot"></div>
      <div class="crm-tl-body" onclick="crmOpenDetail('\${c.id}')">
        <div class="crm-tl-who">\${escH(c.name)} Â· \${typeLabel[l.type]||'ğŸ“'}</div>
        \${l.note?'<div class="crm-tl-note">'+escH(l.note)+'</div>':''}
      </div>
    </div>`;
  });
  tl.innerHTML=html;
}

// â”€â”€ Detail view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function crmOpenDetail(id){
  crmActiveDetail = id;
  const c = crmData.contacts.find(x=>x.id===id);
  if(!c) return;
  document.getElementById('crm-main').style.display='none';
  const det = document.getElementById('crm-detail');
  det.classList.add('active');
  document.getElementById('crm-detail-name').textContent = c.name;
  renderDetailBody(c);
}

function crmCloseDetail(){
  document.getElementById('crm-detail').classList.remove('active');
  document.getElementById('crm-main').style.display='flex';
  crmActiveDetail = null;
  crmRender();
}

function renderDetailBody(c){
  const logs = crmData.logs.filter(l=>l.contactId===c.id).sort((a,b)=>b.date.localeCompare(a.date)||b.time.localeCompare(a.time));
  const typeLabel={'call':'ğŸ“ Call','text':'ğŸ’¬ Text','email':'âœ‰ï¸ Email','meet':'ğŸ¤ Met','other':'ğŸ“ Note'};
  const badgeLabel={friend:'Friend / Family',pro:'Professional',client:'Client'};

  const tags=(c.tags||[]).map(function(t){
    return '<span class="crm-tag">'+escH(t)+'<button class="crm-tag-x" onclick="crmRemoveTag(\''+c.id+'\',\''+escH(t)+'\')">Ã—</button></span>';
  }).join('');

  let logsHtml='';
  if(logs.length){
    logs.forEach(function(l){
      logsHtml+='<div class="crm-log-item">'
        +'<div class="crm-log-date">'+fmtDate(l.date)+' Â· '+(typeLabel[l.type]||'ğŸ“')+'</div>'
        +'<div class="crm-log-text">'+escH(l.note||'(no note)')+'</div>'
        +'<button class="crm-log-del" onclick="crmDelLog(\''+l.id+'\',\''+c.id+'\')">Ã—</button>'
        +'</div>';
    });
  } else {
    logsHtml='<div style="color:var(--muted);font-size:11px;padding:8px 0">No interactions yet.</div>';
  }

  document.getElementById('crm-detail-body').innerHTML=
    '<div style="text-align:center;padding:10px 0 4px">'
    +'<div class="crm-detail-avatar" style="background:'+crmColor(c.name)+'">'+crmInitials(c.name)+'</div>'
    +'<div class="crm-detail-fullname">'+escH(c.name)+'</div>'
    +'<div class="crm-detail-type"><span class="crm-badge crm-badge-'+c.type+'">'+(badgeLabel[c.type]||c.type)+'</span></div>'
    +'</div>'

    +'<div>'
    +'<div class="crm-sec-title">Contact Info</div>'
    +'<div class="crm-field-group">'
    +'<div class="crm-field"><span class="crm-field-label">Company</span><input class="crm-field-val" value="'+escH(c.company||'')+'" placeholder="â€”" onchange="crmPatch(\''+c.id+'\',\'company\',this.value)" /></div>'
    +'<div class="crm-field"><span class="crm-field-label">Phone</span><input class="crm-field-val" value="'+escH(c.phone||'')+'" placeholder="â€”" type="tel" onchange="crmPatch(\''+c.id+'\',\'phone\',this.value)" /></div>'
    +'<div class="crm-field"><span class="crm-field-label">Email</span><input class="crm-field-val" value="'+escH(c.email||'')+'" placeholder="â€”" type="email" onchange="crmPatch(\''+c.id+'\',\'email\',this.value)" /></div>'
    +'<div class="crm-field"><span class="crm-field-label">Social</span><input class="crm-field-val" value="'+escH(c.social||'')+'" placeholder="â€”" onchange="crmPatch(\''+c.id+'\',\'social\',this.value)" /></div>'
    +'</div></div>'

    +'<div>'
    +'<div class="crm-sec-title">Tags</div>'
    +'<div class="crm-tags-wrap" id="crm-tags-wrap-'+c.id+'">'
    +tags
    +'<input class="crm-tag-input" placeholder="+ tag" onkeydown="if(event.key===\'Enter\'||event.key===\',\'){event.preventDefault();crmAddTag(\''+c.id+'\',this.value);this.value=\'\'}" />'
    +'</div></div>'

    +'<div>'
    +'<div class="crm-sec-title">Follow-up</div>'
    +'<div class="crm-field-group">'
    +'<div class="crm-field"><span class="crm-field-label">Date</span><input class="crm-field-val" type="date" value="'+(c.followup&&c.followup.date?c.followup.date:'')+'" onchange="crmPatchFollowup(\''+c.id+'\',\'date\',this.value)" /></div>'
    +'<div class="crm-field"><span class="crm-field-label">Action</span><input class="crm-field-val" value="'+escH((c.followup&&c.followup.action)||'')+'" placeholder="e.g. Call to check in" onchange="crmPatchFollowup(\''+c.id+'\',\'action\',this.value)" /></div>'
    +'</div></div>'

    +'<div>'
    +'<div class="crm-sec-title" style="display:flex;justify-content:space-between;align-items:center">'
    +'<span>History <span style="opacity:.5;font-size:9px;font-weight:normal">'+logs.length+' entries</span></span>'
    +'<button onclick="crmOpenLogModal(\''+c.id+'\')" style="background:var(--accent);color:#0e0e10;border:none;border-radius:8px;padding:4px 10px;font-family:\'DM Mono\',monospace;font-size:10px;font-weight:700;cursor:pointer">+ Log</button>'
    +'</div>'
    +'<div id="crm-log-list-'+c.id+'">'+logsHtml+'</div>'
    +'</div>';
}

function crmPatch(id, key, val){
  const c = crmData.contacts.find(x=>x.id===id);
  if(c){ c[key]=val; crmSave(); }
}
function crmPatchFollowup(id, key, val){
  const c = crmData.contacts.find(x=>x.id===id);
  if(!c) return;
  if(!c.followup) c.followup={};
  c.followup[key]=val;
  crmSave();
}
function crmAddTag(id, raw){
  const tag=(raw||'').replace(/,/g,'').trim();
  if(!tag) return;
  const c=crmData.contacts.find(x=>x.id===id);
  if(!c) return;
  if(!c.tags) c.tags=[];
  if(!c.tags.includes(tag)){c.tags.push(tag);crmSave();}
  renderDetailBody(c);
}
function crmRemoveTag(id, tag){
  const c=crmData.contacts.find(x=>x.id===id);
  if(!c||!c.tags) return;
  c.tags=c.tags.filter(t=>t!==tag);crmSave();renderDetailBody(c);
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function crmOpenAddModal(){
  ['crm-m-name','crm-m-company','crm-m-phone','crm-m-email','crm-m-social'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('crm-m-type').value='friend';
  document.getElementById('crm-modal-title').textContent='New Contact';
  document.getElementById('crm-contact-modal').classList.add('active');
}
function crmCloseContactModal(){document.getElementById('crm-contact-modal').classList.remove('active')}
function crmSaveContactModal(){
  const name=document.getElementById('crm-m-name').value.trim();
  if(!name) return;
  const c={
    id:'c'+Date.now(),name,
    type:document.getElementById('crm-m-type').value,
    company:document.getElementById('crm-m-company').value.trim(),
    phone:document.getElementById('crm-m-phone').value.trim(),
    email:document.getElementById('crm-m-email').value.trim(),
    social:document.getElementById('crm-m-social').value.trim(),
    tags:[],followup:null,created:new Date().toISOString()
  };
  crmData.contacts.push(c);crmSave();crmCloseContactModal();crmRender();
}

function crmDeleteContact(){
  if(!crmActiveDetail) return;
  const c=crmData.contacts.find(x=>x.id===crmActiveDetail);
  if(!c||!confirm('Delete '+c.name+'?')) return;
  crmData.contacts=crmData.contacts.filter(x=>x.id!==crmActiveDetail);
  crmData.logs=crmData.logs.filter(x=>x.contactId!==crmActiveDetail);
  crmSave();crmCloseDetail();
}

function crmOpenLogModal(id){
  crmActiveDetail=id;
  document.getElementById('crm-l-note').value='';
  document.getElementById('crm-l-type').value='call';
  delete document.getElementById('crm-log-modal').dataset.clearFollowup;
  document.getElementById('crm-log-modal').classList.add('active');
}
function crmCloseLogModal(){document.getElementById('crm-log-modal').classList.remove('active')}
function crmSaveLog(){
  if(!crmActiveDetail) return;
  const today=new Date();
  const pad=n=>String(n).padStart(2,'0');
  const log={
    id:'l'+Date.now(),
    contactId:crmActiveDetail,
    type:document.getElementById('crm-l-type').value,
    note:document.getElementById('crm-l-note').value.trim(),
    date:today.getFullYear()+'-'+pad(today.getMonth()+1)+'-'+pad(today.getDate()),
    time:pad(today.getHours())+':'+pad(today.getMinutes())
  };
  crmData.logs.push(log);
  // If came from queue "mark done", clear the followup
  const clearId=document.getElementById('crm-log-modal').dataset.clearFollowup;
  if(clearId){const c=crmData.contacts.find(x=>x.id===clearId);if(c)c.followup=null;}
  crmSave();crmCloseLogModal();
  // Refresh wherever we are
  if(document.getElementById('crm-detail').classList.contains('active')){
    const c=crmData.contacts.find(x=>x.id===crmActiveDetail);if(c)renderDetailBody(c);
  } else {crmRender();}
}
function crmDelLog(logId, contactId){
  crmData.logs=crmData.logs.filter(l=>l.id!==logId);
  crmSave();
  const c=crmData.contacts.find(x=>x.id===contactId);if(c)renderDetailBody(c);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize',()=>{if(document.getElementById('s-tower').classList.contains('active')){gResizeCanvas()}});
setTimeout(()=>{gResizeCanvas();gBuildTowerBtns()},100);
</script>
</body>
</html>
